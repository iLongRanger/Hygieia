// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// CORE IDENTITY TABLES
// ============================================================

model User {
  id             String    @id @default(uuid()) @db.Uuid
  supabaseUserId String?   @unique @map("supabase_user_id") @db.Uuid
  email          String    @unique @db.VarChar(255)
  passwordHash   String?   @map("password_hash") @db.VarChar(255)
  fullName       String    @map("full_name") @db.VarChar(255)
  phone          String?   @db.VarChar(20)
  avatarUrl      String?   @map("avatar_url") @db.Text
  status         String    @default("active") @db.VarChar(20)
  lastLoginAt    DateTime? @map("last_login_at") @db.Timestamptz(6)
  preferences              Json      @default("{}") @db.JsonB
  notificationPreferences  Json      @default("{}") @map("notification_preferences") @db.JsonB
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  roles                    UserRole[]        @relation("UserRoles")
  refreshTokens            RefreshToken[]    @relation("UserRefreshTokens")
  createdLeads             Lead[]            @relation("CreatedLeads")
  createdAccounts          Account[]         @relation("CreatedAccounts")
  createdContacts          Contact[]         @relation("CreatedContacts")
  createdFacilities        Facility[]        @relation("CreatedFacilities")
  createdAreas             Area[]            @relation("CreatedAreas")
  createdTasks             FacilityTask[]    @relation("CreatedTasks")
  assignedToLeads          Lead[]            @relation("AssignedToLeads")
  convertedLeads           Lead[]            @relation("ConvertedLeads")
  managedAccounts          Account[]         @relation("AccountManager")
  facilities               Facility[]        @relation("FacilityManager")
  createdTaskTemplates     TaskTemplate[]    @relation("CreatedTaskTemplates")
  createdAreaTemplates     AreaTemplate[]    @relation("CreatedAreaTemplates")
  createdProposals         Proposal[]        @relation("CreatedProposals")
  proposalActivities       ProposalActivity[] @relation("ProposalActivities")
  createdProposalTemplates ProposalTemplate[] @relation("CreatedProposalTemplates")
  proposalVersions         ProposalVersion[] @relation("ProposalVersions")
  createdContracts         Contract[]        @relation("CreatedContracts")
  createdTeams             Team[]            @relation("CreatedTeams")
  approvedContracts        Contract[]        @relation("ApprovedContracts")
  initialCleanCompletedContracts Contract[]  @relation("InitialCleanCompletedContracts")
  contractActivities             ContractActivity[] @relation("ContractActivities")
  createdAppointments      Appointment[]     @relation("CreatedAppointments")
  assignedAppointments     Appointment[]     @relation("AssignedAppointments")
  notifications            Notification[]    @relation("UserNotifications")
  accountActivities        AccountActivity[] @relation("AccountActivities")
  assignedJobs             Job[]             @relation("AssignedJobs")
  createdJobs              Job[]             @relation("CreatedJobs")
  completedJobTasks        JobTask[]         @relation("CompletedJobTasks")
  createdJobNotes          JobNote[]         @relation("CreatedJobNotes")
  jobActivities            JobActivity[]     @relation("JobActivities")
  createdInspectionTemplates InspectionTemplate[] @relation("CreatedInspectionTemplates")
  inspectorInspections     Inspection[]      @relation("InspectorInspections")
  inspectionActivities     InspectionActivity[] @relation("InspectionActivities")
  createdInspectionCorrectiveActions  InspectionCorrectiveAction[] @relation("CreatedInspectionCorrectiveActions")
  assignedInspectionCorrectiveActions InspectionCorrectiveAction[] @relation("AssignedInspectionCorrectiveActions")
  resolvedInspectionCorrectiveActions InspectionCorrectiveAction[] @relation("ResolvedInspectionCorrectiveActions")
  verifiedInspectionCorrectiveActions InspectionCorrectiveAction[] @relation("VerifiedInspectionCorrectiveActions")
  inspectionSignoffs       InspectionSignoff[] @relation("InspectionSignoffs")
  timeEntries              TimeEntry[]          @relation("UserTimeEntries")
  approvedTimeEntries      TimeEntry[]          @relation("ApprovedTimeEntries")
  editedTimeEntries        TimeEntry[]          @relation("EditedTimeEntries")
  timesheets               Timesheet[]          @relation("UserTimesheets")
  approvedTimesheets       Timesheet[]          @relation("ApprovedTimesheets")
  createdInvoices          Invoice[]            @relation("CreatedInvoices")
  invoiceActivities        InvoiceActivity[]    @relation("InvoiceActivities")
  recordedPayments         InvoicePayment[]     @relation("RecordedPayments")
  createdQuotations        Quotation[]          @relation("CreatedQuotations")
  quotationActivities      QuotationActivity[]  @relation("QuotationActivities")

  @@index([email])
  @@index([status])
  @@map("users")
}

model RefreshToken {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  tokenJti     String    @unique @map("token_jti") @db.VarChar(255)
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedReason String?  @map("revoked_reason") @db.VarChar(50)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent") @db.Text

  user User @relation("UserRefreshTokens", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenJti])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Role {
  id           String   @id @default(uuid()) @db.Uuid
  key          String   @unique @db.VarChar(50)
  label        String   @db.VarChar(100)
  description  String?  @db.Text
  permissions  Json     @default("{}") @db.JsonB
  isSystemRole Boolean  @default(false) @map("is_system_role")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  id               String    @id @default(uuid()) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  roleId           String    @map("role_id") @db.Uuid
  assignedByUserId String?   @map("assigned_by_user_id") @db.Uuid
  assignedAt       DateTime  @default(now()) @map("assigned_at") @db.Timestamptz(6)
  expiresAt        DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// ============================================================
// CRM & SALES PIPELINE TABLES
// ============================================================

model LeadSource {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  color       String   @default("#6B7280") @db.VarChar(7)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  leads Lead[]

  @@index([isActive])
  @@map("lead_sources")
}

model Lead {
  id                String    @id @default(uuid()) @db.Uuid
  leadSourceId      String?   @map("lead_source_id") @db.Uuid
  status            String    @default("lead") @db.VarChar(30)
  companyName       String?   @map("company_name") @db.VarChar(255)
  contactName       String    @map("contact_name") @db.VarChar(255)
  primaryEmail      String?   @map("primary_email") @db.VarChar(255)
  primaryPhone      String?   @map("primary_phone") @db.VarChar(20)
  secondaryEmail    String?   @map("secondary_email") @db.VarChar(255)
  secondaryPhone    String?   @map("secondary_phone") @db.VarChar(20)
  address           Json?     @db.JsonB
  estimatedValue    Decimal?  @map("estimated_value") @db.Decimal(12, 2)
  probability       Int?      @default(0)
  expectedCloseDate DateTime? @map("expected_close_date") @db.Date
  notes             String?   @db.Text
  lostReason        String?   @map("lost_reason") @db.Text
  assignedToUserId  String?   @map("assigned_to_user_id") @db.Uuid
  createdByUserId   String    @map("created_by_user_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt        DateTime? @map("archived_at") @db.Timestamptz(6)

  // Conversion tracking
  convertedToAccountId String?   @unique @map("converted_to_account_id") @db.Uuid
  convertedAt          DateTime? @map("converted_at") @db.Timestamptz(6)
  convertedByUserId    String?   @map("converted_by_user_id") @db.Uuid

  leadSource         LeadSource? @relation(fields: [leadSourceId], references: [id])
  assignedToUser     User?       @relation("AssignedToLeads", fields: [assignedToUserId], references: [id])
  createdByUser      User        @relation("CreatedLeads", fields: [createdByUserId], references: [id])
  convertedToAccount Account?    @relation("LeadToAccount", fields: [convertedToAccountId], references: [id])
  convertedByUser    User?       @relation("ConvertedLeads", fields: [convertedByUserId], references: [id])
  appointments       Appointment[] @relation("LeadAppointments")

  @@index([status])
  @@index([leadSourceId])
  @@index([assignedToUserId])
  @@index([primaryEmail])
  @@index([expectedCloseDate])
  @@index([createdAt])
  @@index([convertedToAccountId])
  @@map("leads")
}

model Appointment {
  id                String    @id @default(uuid()) @db.Uuid
  leadId            String?   @map("lead_id") @db.Uuid
  accountId         String?   @map("account_id") @db.Uuid
  type              String    @default("walk_through") @db.VarChar(30)
  status            String    @default("scheduled") @db.VarChar(30)
  scheduledStart    DateTime  @map("scheduled_start") @db.Timestamptz(6)
  scheduledEnd      DateTime  @map("scheduled_end") @db.Timestamptz(6)
  timezone          String    @db.VarChar(50)
  location          String?   @db.Text
  notes             String?   @db.Text
  completionNotes   String?   @map("completion_notes") @db.Text
  actualDuration    Int?      @map("actual_duration") // minutes
  assignedToUserId  String    @map("assigned_to_user_id") @db.Uuid
  assignedTeamId    String?   @map("assigned_team_id") @db.Uuid
  createdByUserId   String    @map("created_by_user_id") @db.Uuid
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)
  reminderSentAt    DateTime? @map("reminder_sent_at") @db.Timestamptz(6)
  rescheduledFromId String?   @map("rescheduled_from_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  lead            Lead?        @relation("LeadAppointments", fields: [leadId], references: [id], onDelete: Cascade)
  account         Account?     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  assignedToUser  User         @relation("AssignedAppointments", fields: [assignedToUserId], references: [id])
  assignedTeam    Team?        @relation("AssignedTeamAppointments", fields: [assignedTeamId], references: [id], onDelete: SetNull)
  createdByUser   User         @relation("CreatedAppointments", fields: [createdByUserId], references: [id])
  inspectionId    String?      @unique @map("inspection_id") @db.Uuid
  rescheduledFrom Appointment? @relation("AppointmentReschedules", fields: [rescheduledFromId], references: [id])
  reschedules     Appointment[] @relation("AppointmentReschedules")
  inspection      Inspection?  @relation("AppointmentInspection", fields: [inspectionId], references: [id], onDelete: SetNull)

  @@index([leadId])
  @@index([accountId])
  @@index([assignedToUserId])
  @@index([assignedTeamId])
  @@index([scheduledStart])
  @@index([status])
  @@map("appointments")
}

model Notification {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      String    @db.VarChar(50)
  title     String    @db.VarChar(255)
  body      String?   @db.Text
  metadata  Json      @default("{}") @db.JsonB
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)
  emailSent Boolean   @default(false) @map("email_sent")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([readAt])
  @@index([type])
  @@map("notifications")
}

model Account {
  id               String    @id @default(uuid()) @db.Uuid
  name             String    @unique @db.VarChar(255)
  type             String    @db.VarChar(20)
  industry         String?   @db.VarChar(100)
  website          String?   @db.VarChar(500)
  billingEmail     String?   @map("billing_email") @db.VarChar(255)
  billingPhone     String?   @map("billing_phone") @db.VarChar(20)
  billingAddress   Json?     @map("billing_address") @db.JsonB
  qboCustomerId    String?   @map("qbo_customer_id") @db.VarChar(50)
  taxId            String?   @map("tax_id") @db.VarChar(50)
  paymentTerms     String    @default("NET30") @map("payment_terms") @db.VarChar(50)
  creditLimit      Decimal?  @map("credit_limit") @db.Decimal(12, 2)
  accountManagerId String?   @map("account_manager_id") @db.Uuid
  notes            String?   @db.Text
  createdByUserId  String    @map("created_by_user_id") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt       DateTime? @map("archived_at") @db.Timestamptz(6)

  // Default pricing plan for this account
  defaultPricingPlanId String? @map("default_pricing_plan_id") @db.Uuid

  contacts       Contact[]
  facilities     Facility[]
  proposals      Proposal[]
  contracts      Contract[]
  appointments   Appointment[]
  accountManager User?      @relation("AccountManager", fields: [accountManagerId], references: [id])
  createdByUser  User       @relation("CreatedAccounts", fields: [createdByUserId], references: [id])
  sourceLead     Lead?      @relation("LeadToAccount")
  defaultPricingPlan PricingSettings? @relation("AccountDefaultPricingPlan", fields: [defaultPricingPlanId], references: [id])
  activities         AccountActivity[]
  jobs               Job[] @relation("AccountJobs")
  inspections        Inspection[] @relation("AccountInspections")
  invoices           Invoice[]    @relation("AccountInvoices")
  quotations         Quotation[]  @relation("AccountQuotations")

  @@index([type])
  @@index([accountManagerId])
  @@index([qboCustomerId])
  @@index([defaultPricingPlanId])
  @@map("accounts")
}

model Contact {
  id              String    @id @default(uuid()) @db.Uuid
  accountId       String?   @map("account_id") @db.Uuid
  name            String    @db.VarChar(255)
  email           String?   @db.VarChar(255)
  phone           String?   @db.VarChar(20)
  mobile          String?   @db.VarChar(20)
  title           String?   @db.VarChar(100)
  department      String?   @db.VarChar(100)
  isPrimary       Boolean   @default(false) @map("is_primary")
  isBilling       Boolean   @default(false) @map("is_billing")
  notes           String?   @db.Text
  createdByUserId String    @map("created_by_user_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt      DateTime? @map("archived_at") @db.Timestamptz(6)

  account       Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("CreatedContacts", fields: [createdByUserId], references: [id])

  @@unique([accountId, isPrimary])
  @@index([accountId])
  @@index([email])
  @@index([isPrimary])
  @@index([isBilling])
  @@map("contacts")
}

model AccountActivity {
  id                String   @id @default(uuid()) @db.Uuid
  accountId         String   @map("account_id") @db.Uuid
  entryType         String   @map("entry_type") @db.VarChar(30)
  note              String   @db.Text
  performedByUserId String?  @map("performed_by_user_id") @db.Uuid
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  account         Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  performedByUser User?   @relation("AccountActivities", fields: [performedByUserId], references: [id], onDelete: SetNull)

  @@index([accountId])
  @@index([entryType])
  @@index([createdAt])
  @@map("account_activities")
}

// ============================================================
// FACILITY MANAGEMENT TABLES
// ============================================================

model AreaType {
  id                      String   @id @default(uuid()) @db.Uuid
  name                    String   @unique @db.VarChar(100)
  description             String?  @db.Text
  defaultSquareFeet       Decimal? @map("default_square_feet") @db.Decimal(10, 2)
  baseCleaningTimeMinutes Int?     @map("base_cleaning_time_minutes")
  guidanceItems           Json?    @map("guidance_items") @db.JsonB
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  areas         Area[]
  taskTemplates TaskTemplate[]
  areaTemplate  AreaTemplate?

  @@index([name])
  @@map("area_types")
}

model Facility {
  id                  String    @id @default(uuid()) @db.Uuid
  accountId           String    @map("account_id") @db.Uuid
  name                String    @db.VarChar(255)
  address             Json      @db.JsonB
  squareFeet          Decimal?  @map("square_feet") @db.Decimal(10, 2)
  buildingType        String?   @map("building_type") @db.VarChar(50)
  accessInstructions  String?   @map("access_instructions") @db.Text
  parkingInfo         String?   @map("parking_info") @db.Text
  specialRequirements String?   @map("special_requirements") @db.Text
  facilityManagerId   String?   @map("facility_manager_id") @db.Uuid
  status              String    @default("active") @db.VarChar(20)
  notes               String?   @db.Text
  createdByUserId     String    @map("created_by_user_id") @db.Uuid
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt          DateTime? @map("archived_at") @db.Timestamptz(6)

  // Default pricing plan for this facility (overrides account default)
  defaultPricingPlanId String? @map("default_pricing_plan_id") @db.Uuid

  account          Account           @relation(fields: [accountId], references: [id])
  areas            Area[]
  taskTemplates    TaskTemplate[]    @relation("FacilityTaskTemplates")
  facilityTasks    FacilityTask[]    @relation("FacilityTasks")
  proposals        Proposal[]
  contracts        Contract[]
  facilityManager  User?             @relation("FacilityManager", fields: [facilityManagerId], references: [id])
  createdByUser    User              @relation("CreatedFacilities", fields: [createdByUserId], references: [id])
  defaultPricingPlan PricingSettings? @relation("FacilityDefaultPricingPlan", fields: [defaultPricingPlanId], references: [id])
  jobs             Job[]             @relation("FacilityJobs")
  inspections      Inspection[]     @relation("FacilityInspections")
  timeEntries      TimeEntry[]      @relation("FacilityTimeEntries")
  invoices         Invoice[]        @relation("FacilityInvoices")
  quotations       Quotation[]      @relation("FacilityQuotations")

  @@unique([accountId, name])
  @@index([accountId])
  @@index([status])
  @@index([facilityManagerId])
  @@index([defaultPricingPlanId])
  @@map("facilities")
}

model Area {
  id              String    @id @default(uuid()) @db.Uuid
  facilityId      String    @map("facility_id") @db.Uuid
  areaTypeId      String    @map("area_type_id") @db.Uuid
  name            String?   @db.VarChar(255)
  quantity        Int       @default(1)
  length          Decimal?  @db.Decimal(10, 2)
  width           Decimal?  @db.Decimal(10, 2)
  squareFeet      Decimal?  @map("square_feet") @db.Decimal(10, 2)
  floorType       String    @default("vct") @map("floor_type") @db.VarChar(20)
  conditionLevel  String    @default("standard") @map("condition_level") @db.VarChar(20)
  roomCount       Int       @default(0) @map("room_count")
  unitCount       Int       @default(0) @map("unit_count")
  trafficLevel    String    @default("medium") @map("traffic_level") @db.VarChar(20)
  notes           String?   @db.Text
  createdByUserId String    @map("created_by_user_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt      DateTime? @map("archived_at") @db.Timestamptz(6)

  facility      Facility       @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  areaType      AreaType       @relation(fields: [areaTypeId], references: [id])
  facilityTasks FacilityTask[]
  fixtures      AreaFixture[]
  createdByUser User           @relation("CreatedAreas", fields: [createdByUserId], references: [id])

  @@unique([facilityId, name])
  @@index([facilityId])
  @@index([areaTypeId])
  @@index([conditionLevel])
  @@index([floorType])
  @@index([trafficLevel])
  @@map("areas")
}

// ============================================================
// TASK MANAGEMENT TABLES
// ============================================================

model TaskTemplate {
  id                String    @id @default(uuid()) @db.Uuid
  name              String    @db.VarChar(255)
  description       String?   @db.Text
  cleaningType      String    @map("cleaning_type") @db.VarChar(50)
  areaTypeId        String?   @map("area_type_id") @db.Uuid
  estimatedMinutes  Int       @map("estimated_minutes")
  baseMinutes       Decimal   @default(0) @map("base_minutes") @db.Decimal(10, 4)
  perSqftMinutes    Decimal   @default(0) @map("per_sqft_minutes") @db.Decimal(10, 4)
  perUnitMinutes    Decimal   @default(0) @map("per_unit_minutes") @db.Decimal(10, 4)
  perRoomMinutes    Decimal   @default(0) @map("per_room_minutes") @db.Decimal(10, 4)
  difficultyLevel   Int       @default(3) @map("difficulty_level")
  requiredEquipment Json      @default("[]") @map("required_equipment") @db.JsonB
  requiredSupplies  Json      @default("[]") @map("required_supplies") @db.JsonB
  instructions      String?   @db.Text
  isGlobal          Boolean   @default(false) @map("is_global")
  facilityId        String?   @map("facility_id") @db.Uuid
  version           Int       @default(1)
  isActive          Boolean   @default(true) @map("is_active")
  createdByUserId   String    @map("created_by_user_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt        DateTime? @map("archived_at") @db.Timestamptz(6)

  areaType             AreaType?            @relation(fields: [areaTypeId], references: [id])
  facility             Facility?            @relation("FacilityTaskTemplates", fields: [facilityId], references: [id])
  facilityTasks        FacilityTask[]
  fixtureMinutes       TaskFixtureMinutes[]
  areaTemplateTasks    AreaTemplateTask[]
  createdByUser        User                 @relation("CreatedTaskTemplates", fields: [createdByUserId], references: [id])

  @@index([cleaningType])
  @@index([areaTypeId])
  @@index([facilityId])
  @@index([isActive])
  @@index([isGlobal])
  @@map("task_templates")
}

model FacilityTask {
  id                  String    @id @default(uuid()) @db.Uuid
  facilityId          String    @map("facility_id") @db.Uuid
  areaId              String?   @map("area_id") @db.Uuid
  taskTemplateId      String?   @map("task_template_id") @db.Uuid
  customName          String?   @map("custom_name") @db.VarChar(255)
  customInstructions  String?   @map("custom_instructions") @db.Text
  estimatedMinutes    Int?      @map("estimated_minutes")
  baseMinutesOverride    Decimal? @map("base_minutes_override") @db.Decimal(10, 4)
  perSqftMinutesOverride Decimal? @map("per_sqft_minutes_override") @db.Decimal(10, 4)
  perUnitMinutesOverride Decimal? @map("per_unit_minutes_override") @db.Decimal(10, 4)
  perRoomMinutesOverride Decimal? @map("per_room_minutes_override") @db.Decimal(10, 4)
  isRequired          Boolean   @default(true) @map("is_required")
  cleaningFrequency   String    @default("daily") @map("cleaning_frequency") @db.VarChar(20)
  conditionMultiplier Decimal   @default(1.0) @map("condition_multiplier") @db.Decimal(3, 2)
  priority            Int       @default(3)
  createdByUserId     String    @map("created_by_user_id") @db.Uuid
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt          DateTime? @map("archived_at") @db.Timestamptz(6)

  facility            Facility                   @relation("FacilityTasks", fields: [facilityId], references: [id], onDelete: Cascade)
  area                Area?                      @relation(fields: [areaId], references: [id])
  taskTemplate        TaskTemplate?              @relation(fields: [taskTemplateId], references: [id])
  fixtureMinutes      FacilityTaskFixtureMinutes[]
  createdByUser       User                       @relation("CreatedTasks", fields: [createdByUserId], references: [id])
  jobTasks            JobTask[]                  @relation("JobFacilityTasks")

  @@index([facilityId])
  @@index([areaId])
  @@index([taskTemplateId])
  @@index([cleaningFrequency])
  @@index([priority])
  @@map("facility_tasks")
}

// ============================================================
// PRICING TABLES
// ============================================================

model PricingSettings {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique @db.VarChar(100)
  pricingType String @default("square_foot") @map("pricing_type") @db.VarChar(20)

  // Base Rate
  baseRatePerSqFt      Decimal @default(0.10) @map("base_rate_per_sq_ft") @db.Decimal(8, 4)
  minimumMonthlyCharge Decimal @default(250) @map("minimum_monthly_charge") @db.Decimal(10, 2)
  hourlyRate           Decimal @default(35.00) @map("hourly_rate") @db.Decimal(8, 2)

  // Labor Cost Settings
  laborCostPerHour       Decimal @default(18.00) @map("labor_cost_per_hour") @db.Decimal(8, 2) // Average hourly wage
  laborBurdenPercentage  Decimal @default(0.25) @map("labor_burden_percentage") @db.Decimal(5, 4) // Payroll taxes, benefits (25%)
  sqftPerLaborHour       Json @default("{\"office\": 2500, \"medical\": 1500, \"industrial\": 2200, \"retail\": 2400, \"educational\": 2000, \"warehouse\": 3500, \"residential\": 2200, \"mixed\": 2200, \"other\": 2500}") @map("sqft_per_labor_hour") @db.JsonB // Productivity rate per building type: sq ft cleaned per hour

  // Overhead Cost Settings (as percentages of labor cost)
  insurancePercentage     Decimal @default(0.08) @map("insurance_percentage") @db.Decimal(5, 4) // Liability + workers comp (8%)
  adminOverheadPercentage Decimal @default(0.12) @map("admin_overhead_percentage") @db.Decimal(5, 4) // Admin costs (12%)
  travelCostPerVisit      Decimal @default(15.00) @map("travel_cost_per_visit") @db.Decimal(8, 2) // Flat travel cost per visit
  equipmentPercentage     Decimal @default(0.05) @map("equipment_percentage") @db.Decimal(5, 4) // Equipment depreciation (5%)

  // Supply Cost Settings
  supplyCostPercentage Decimal @default(0.04) @map("supply_cost_percentage") @db.Decimal(5, 4) // Supplies as % of labor+overhead (4%)
  supplyCostPerSqFt    Decimal? @map("supply_cost_per_sq_ft") @db.Decimal(8, 4) // Alternative: flat rate per sq ft

  // Profit Settings
  targetProfitMargin Decimal @default(0.25) @map("target_profit_margin") @db.Decimal(5, 4) // Target profit margin (25%)

  // Subcontractor Settings
  subcontractorPercentage Decimal @default(0.60) @map("subcontractor_percentage") @db.Decimal(5, 4) // Sub gets 60% of monthly total

  // Multipliers stored as JSON
  floorTypeMultipliers    Json @default("{\"vct\": 1.0, \"carpet\": 1.15, \"tile\": 1.1, \"hardwood\": 1.2, \"concrete\": 0.9, \"other\": 1.0}") @map("floor_type_multipliers") @db.JsonB
  frequencyMultipliers    Json @default("{\"1x_week\": 1.0, \"2x_week\": 1.8, \"3x_week\": 2.5, \"4x_week\": 3.2, \"5x_week\": 4.0, \"daily\": 4.33, \"weekly\": 1.0, \"biweekly\": 0.5, \"monthly\": 0.25, \"quarterly\": 0.083}") @map("frequency_multipliers") @db.JsonB
  conditionMultipliers    Json @default("{\"standard\": 1.0, \"medium\": 1.25, \"hard\": 1.33}") @map("condition_multipliers") @db.JsonB
  trafficMultipliers      Json @default("{\"low\": 0.9, \"medium\": 1.0, \"high\": 1.15}") @map("traffic_multipliers") @db.JsonB
  taskComplexityAddOns    Json @default("{\"standard\": 0, \"sanitization\": 0.15, \"biohazard\": 0.5, \"high_security\": 0.2}") @map("task_complexity_add_ons") @db.JsonB

  isActive  Boolean   @default(true) @map("is_active")
  isDefault Boolean   @default(false) @map("is_default")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt DateTime? @map("archived_at") @db.Timestamptz(6)

  defaultForAccounts  Account[]  @relation("AccountDefaultPricingPlan")
  defaultForFacilities Facility[] @relation("FacilityDefaultPricingPlan")
  proposals            Proposal[] @relation("ProposalPricingPlan")

  @@index([isActive])
  @@index([pricingType])
  @@index([isDefault])
  @@map("pricing_settings")
}

model FixtureType {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  category    String   @default("fixture") @db.VarChar(20)
  defaultMinutesPerItem Decimal @default(0) @map("default_minutes_per_item") @db.Decimal(10, 4)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  areaFixtures              AreaFixture[]
  taskFixtureMinutes        TaskFixtureMinutes[]
  facilityTaskFixtureMinutes FacilityTaskFixtureMinutes[]
  areaTemplateItems         AreaTemplateItem[]

  @@index([isActive])
  @@map("fixture_types")
}

model AreaFixture {
  id            String    @id @default(uuid()) @db.Uuid
  areaId        String    @map("area_id") @db.Uuid
  fixtureTypeId String    @map("fixture_type_id") @db.Uuid
  count         Int       @default(0)
  minutesPerItem Decimal  @default(0) @map("minutes_per_item") @db.Decimal(10, 4)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  area        Area        @relation(fields: [areaId], references: [id], onDelete: Cascade)
  fixtureType FixtureType @relation(fields: [fixtureTypeId], references: [id], onDelete: Cascade)

  @@unique([areaId, fixtureTypeId])
  @@index([areaId])
  @@index([fixtureTypeId])
  @@map("area_fixtures")
}

model AreaTemplate {
  id                String    @id @default(uuid()) @db.Uuid
  areaTypeId        String    @unique @map("area_type_id") @db.Uuid
  name              String?   @db.VarChar(255)
  defaultSquareFeet Decimal?  @map("default_square_feet") @db.Decimal(10, 2)
  createdByUserId   String    @map("created_by_user_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  areaType    AreaType          @relation(fields: [areaTypeId], references: [id])
  items       AreaTemplateItem[]
  tasks       AreaTemplateTask[]
  createdByUser User            @relation("CreatedAreaTemplates", fields: [createdByUserId], references: [id])

  @@index([areaTypeId])
  @@map("area_templates")
}

model AreaTemplateItem {
  id             String    @id @default(uuid()) @db.Uuid
  areaTemplateId String    @map("area_template_id") @db.Uuid
  fixtureTypeId  String    @map("fixture_type_id") @db.Uuid
  defaultCount   Int       @default(0) @map("default_count")
  minutesPerItem Decimal   @default(0) @map("minutes_per_item") @db.Decimal(10, 4)
  sortOrder      Int       @default(0) @map("sort_order")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  areaTemplate AreaTemplate @relation(fields: [areaTemplateId], references: [id], onDelete: Cascade)
  fixtureType  FixtureType  @relation(fields: [fixtureTypeId], references: [id], onDelete: Cascade)

  @@unique([areaTemplateId, fixtureTypeId])
  @@index([areaTemplateId])
  @@index([fixtureTypeId])
  @@map("area_template_items")
}

model AreaTemplateTask {
  id             String    @id @default(uuid()) @db.Uuid
  areaTemplateId String    @map("area_template_id") @db.Uuid
  taskTemplateId String?   @map("task_template_id") @db.Uuid
  name           String?   @db.VarChar(255)
  baseMinutes    Decimal?  @map("base_minutes") @db.Decimal(10, 4)
  perSqftMinutes Decimal?  @map("per_sqft_minutes") @db.Decimal(10, 4)
  perUnitMinutes Decimal?  @map("per_unit_minutes") @db.Decimal(10, 4)
  perRoomMinutes Decimal?  @map("per_room_minutes") @db.Decimal(10, 4)
  sortOrder      Int       @default(0) @map("sort_order")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  areaTemplate AreaTemplate @relation(fields: [areaTemplateId], references: [id], onDelete: Cascade)
  taskTemplate TaskTemplate? @relation(fields: [taskTemplateId], references: [id], onDelete: SetNull)

  @@index([areaTemplateId])
  @@index([areaTemplateId, sortOrder])
  @@index([taskTemplateId])
  @@map("area_template_tasks")
}

model TaskFixtureMinutes {
  id                String    @id @default(uuid()) @db.Uuid
  taskTemplateId    String    @map("task_template_id") @db.Uuid
  fixtureTypeId     String    @map("fixture_type_id") @db.Uuid
  minutesPerFixture Decimal   @default(0) @map("minutes_per_fixture") @db.Decimal(10, 4)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  taskTemplate TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  fixtureType  FixtureType  @relation(fields: [fixtureTypeId], references: [id], onDelete: Cascade)

  @@unique([taskTemplateId, fixtureTypeId])
  @@index([taskTemplateId])
  @@index([fixtureTypeId])
  @@map("task_fixture_minutes")
}

model FacilityTaskFixtureMinutes {
  id                String    @id @default(uuid()) @db.Uuid
  facilityTaskId    String    @map("facility_task_id") @db.Uuid
  fixtureTypeId     String    @map("fixture_type_id") @db.Uuid
  minutesPerFixture Decimal   @default(0) @map("minutes_per_fixture") @db.Decimal(10, 4)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  facilityTask FacilityTask @relation(fields: [facilityTaskId], references: [id], onDelete: Cascade)
  fixtureType  FixtureType  @relation(fields: [fixtureTypeId], references: [id], onDelete: Cascade)

  @@unique([facilityTaskId, fixtureTypeId])
  @@index([facilityTaskId])
  @@index([fixtureTypeId])
  @@map("facility_task_fixture_minutes")
}

// ============================================================
// PROPOSAL & ESTIMATE TABLES
// ============================================================

model Proposal {
  id                 String    @id @default(uuid()) @db.Uuid
  accountId          String    @map("account_id") @db.Uuid
  facilityId         String?   @map("facility_id") @db.Uuid
  proposalNumber     String    @unique @map("proposal_number") @db.VarChar(50)
  title              String    @db.VarChar(255)
  status             String    @default("draft") @db.VarChar(20)
  description        String?   @db.Text
  subtotal           Decimal   @default(0) @map("subtotal") @db.Decimal(12, 2)
  taxRate            Decimal   @default(0) @map("tax_rate") @db.Decimal(5, 4)
  taxAmount          Decimal   @default(0) @map("tax_amount") @db.Decimal(12, 2)
  totalAmount        Decimal   @default(0) @map("total_amount") @db.Decimal(12, 2)
  validUntil         DateTime? @map("valid_until") @db.Date
  sentAt             DateTime? @map("sent_at") @db.Timestamptz(6)
  viewedAt           DateTime? @map("viewed_at") @db.Timestamptz(6)
  acceptedAt         DateTime? @map("accepted_at") @db.Timestamptz(6)
  rejectedAt         DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectionReason    String?   @map("rejection_reason") @db.Text
  notes              String?   @db.Text
  termsAndConditions String?   @map("terms_and_conditions") @db.Text
  serviceFrequency   String?   @map("service_frequency") @db.VarChar(30)
  serviceSchedule    Json?     @map("service_schedule") @db.JsonB
  createdByUserId    String    @map("created_by_user_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt         DateTime? @map("archived_at") @db.Timestamptz(6)

  // Pricing plan fields
  pricingPlanId          String?   @map("pricing_plan_id") @db.Uuid
  pricingSnapshot        Json?     @map("pricing_snapshot") @db.JsonB
  pricingLocked          Boolean   @default(false) @map("pricing_locked")
  pricingLockedAt        DateTime? @map("pricing_locked_at") @db.Timestamptz(6)

  // Public access fields
  publicToken            String?   @unique @map("public_token") @db.VarChar(64)
  publicTokenExpiresAt   DateTime? @map("public_token_expires_at") @db.Timestamptz(6)
  signatureName          String?   @map("signature_name") @db.VarChar(255)
  signatureDate          DateTime? @map("signature_date") @db.Timestamptz(6)
  signatureIp            String?   @map("signature_ip") @db.VarChar(45)

  account          Account           @relation(fields: [accountId], references: [id])
  facility         Facility?         @relation(fields: [facilityId], references: [id])
  pricingPlan      PricingSettings?  @relation("ProposalPricingPlan", fields: [pricingPlanId], references: [id])
  createdByUser    User              @relation("CreatedProposals", fields: [createdByUserId], references: [id])
  proposalItems    ProposalItem[]
  proposalServices ProposalService[]
  contracts        Contract[]
  activities       ProposalActivity[]
  versions         ProposalVersion[]

  @@index([accountId])
  @@index([facilityId])
  @@index([status])
  @@index([proposalNumber])
  @@index([validUntil])
  @@index([sentAt])
  @@index([pricingPlanId])
  @@index([pricingLocked])
  @@map("proposals")
}

model ProposalItem {
  id          String   @id @default(uuid()) @db.Uuid
  proposalId  String   @map("proposal_id") @db.Uuid
  itemType    String   @map("item_type") @db.VarChar(50)
  description String   @db.Text
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal  @map("total_price") @db.Decimal(12, 2)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([itemType])
  @@map("proposal_items")
}

model ProposalService {
  id             String   @id @default(uuid()) @db.Uuid
  proposalId     String   @map("proposal_id") @db.Uuid
  serviceName    String   @map("service_name") @db.VarChar(255)
  serviceType    String   @map("service_type") @db.VarChar(50)
  frequency      String   @db.VarChar(20)
  estimatedHours Decimal? @map("estimated_hours") @db.Decimal(10, 2)
  hourlyRate     Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  monthlyPrice   Decimal  @map("monthly_price") @db.Decimal(12, 2)
  description    String?  @db.Text
  includedTasks  Json     @default("[]") @map("included_tasks") @db.JsonB
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([serviceType])
  @@map("proposal_services")
}

model ProposalActivity {
  id              String   @id @default(uuid()) @db.Uuid
  proposalId      String   @map("proposal_id") @db.Uuid
  action          String   @db.VarChar(50)
  performedByUserId String? @map("performed_by_user_id") @db.Uuid
  metadata        Json     @default("{}") @db.JsonB
  ipAddress       String?  @map("ip_address") @db.VarChar(45)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  proposal      Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  performedByUser User?  @relation("ProposalActivities", fields: [performedByUserId], references: [id])

  @@index([proposalId])
  @@index([action])
  @@index([createdAt])
  @@map("proposal_activities")
}

model ProposalTemplate {
  id                 String    @id @default(uuid()) @db.Uuid
  name               String    @unique @db.VarChar(255)
  termsAndConditions String    @map("terms_and_conditions") @db.Text
  isDefault          Boolean   @default(false) @map("is_default")
  createdByUserId    String    @map("created_by_user_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt         DateTime? @map("archived_at") @db.Timestamptz(6)

  createdByUser User @relation("CreatedProposalTemplates", fields: [createdByUserId], references: [id])

  @@index([isDefault])
  @@map("proposal_templates")
}

model ProposalVersion {
  id              String   @id @default(uuid()) @db.Uuid
  proposalId      String   @map("proposal_id") @db.Uuid
  versionNumber   Int      @map("version_number")
  snapshot        Json     @db.JsonB
  changedByUserId String   @map("changed_by_user_id") @db.Uuid
  changeReason    String?  @map("change_reason") @db.VarChar(500)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  proposal      Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  changedByUser User     @relation("ProposalVersions", fields: [changedByUserId], references: [id])

  @@unique([proposalId, versionNumber])
  @@index([proposalId])
  @@map("proposal_versions")
}

// ============================================================
// CONTRACTS & AGREEMENTS TABLES
// ============================================================

model Contract {
  id             String  @id @default(uuid()) @db.Uuid
  contractNumber String  @unique @map("contract_number") @db.VarChar(50)
  title          String  @db.VarChar(255)
  status         String  @default("draft") @db.VarChar(30)
  accountId      String  @map("account_id") @db.Uuid
  facilityId     String? @map("facility_id") @db.Uuid
  proposalId     String? @map("proposal_id") @db.Uuid
  assignedTeamId String? @map("assigned_team_id") @db.Uuid

  // Renewal tracking
  renewalNumber         Int     @default(0) @map("renewal_number")

  // Service Terms
  startDate         DateTime  @map("start_date") @db.Date
  endDate           DateTime? @map("end_date") @db.Date
  serviceFrequency  String?   @map("service_frequency") @db.VarChar(30)
  serviceSchedule   Json?     @map("service_schedule") @db.JsonB
  autoRenew         Boolean   @default(false) @map("auto_renew")
  renewalNoticeDays Int?      @default(30) @map("renewal_notice_days")

  // Financial Terms
  monthlyValue Decimal  @map("monthly_value") @db.Decimal(12, 2)
  totalValue   Decimal? @map("total_value") @db.Decimal(12, 2)
  billingCycle String   @default("monthly") @map("billing_cycle") @db.VarChar(20)
  paymentTerms String   @default("Net 30") @map("payment_terms") @db.VarChar(50)
  subcontractorTier String? @map("subcontractor_tier") @db.VarChar(20)

  // Contract Details
  termsAndConditions  String? @map("terms_and_conditions") @db.Text
  specialInstructions String? @map("special_instructions") @db.Text

  // Document Management
  signedDocumentUrl String?   @map("signed_document_url") @db.Text
  signedDate        DateTime? @map("signed_date") @db.Date
  signedByName      String?   @map("signed_by_name") @db.VarChar(255)
  signedByEmail     String?   @map("signed_by_email") @db.VarChar(255)

  // Workflow
  approvedByUserId  String?   @map("approved_by_user_id") @db.Uuid
  approvedAt        DateTime? @map("approved_at") @db.Timestamptz(6)
  terminationReason String?   @map("termination_reason") @db.Text
  terminatedAt      DateTime? @map("terminated_at") @db.Timestamptz(6)

  // Initial Clean Tracking
  includesInitialClean        Boolean   @default(true) @map("includes_initial_clean")
  initialCleanCompleted       Boolean   @default(false) @map("initial_clean_completed")
  initialCleanCompletedAt     DateTime? @map("initial_clean_completed_at") @db.Timestamptz(6)
  initialCleanCompletedByUserId String?  @map("initial_clean_completed_by_user_id") @db.Uuid

  // Public access
  publicToken          String?   @unique @map("public_token") @db.VarChar(64)
  publicTokenExpiresAt DateTime? @map("public_token_expires_at") @db.Timestamptz(6)
  signatureIp          String?   @map("signature_ip") @db.VarChar(45)
  sentAt               DateTime? @map("sent_at") @db.Timestamptz(6)
  viewedAt             DateTime? @map("viewed_at") @db.Timestamptz(6)

  // Audit
  createdByUserId String    @map("created_by_user_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt      DateTime? @map("archived_at") @db.Timestamptz(6)

  // Relations
  account                    Account   @relation(fields: [accountId], references: [id], onDelete: Restrict)
  facility                   Facility? @relation(fields: [facilityId], references: [id], onDelete: Restrict)
  proposal                   Proposal? @relation(fields: [proposalId], references: [id])
  assignedTeam               Team?     @relation("AssignedTeamContracts", fields: [assignedTeamId], references: [id], onDelete: SetNull)
  approvedByUser             User?     @relation("ApprovedContracts", fields: [approvedByUserId], references: [id])
  createdByUser              User      @relation("CreatedContracts", fields: [createdByUserId], references: [id])
  initialCleanCompletedByUser User?    @relation("InitialCleanCompletedContracts", fields: [initialCleanCompletedByUserId], references: [id])

  @@index([contractNumber])
  @@index([status])
  @@index([accountId])
  @@index([facilityId])
  @@index([proposalId])
  @@index([assignedTeamId])
  @@index([startDate])
  @@index([endDate])
  @@index([publicToken])
  @@index([createdAt])
  @@map("contracts")

  activities ContractActivity[]
  jobs       Job[] @relation("ContractJobs")
  inspections          Inspection[]          @relation("ContractInspections")
  inspectionTemplates  InspectionTemplate[]  @relation("ContractInspectionTemplates")
  timeEntries          TimeEntry[]           @relation("ContractTimeEntries")
  invoices    Invoice[]    @relation("ContractInvoices")
}

model ContractActivity {
  id              String   @id @default(uuid()) @db.Uuid
  contractId      String   @map("contract_id") @db.Uuid
  action          String   @db.VarChar(50)
  performedByUserId String? @map("performed_by_user_id") @db.Uuid
  metadata        Json     @default("{}") @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  contract        Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  performedByUser User?    @relation("ContractActivities", fields: [performedByUserId], references: [id])

  @@index([contractId])
  @@index([action])
  @@index([createdAt])
  @@map("contract_activities")
}

model Team {
  id            String    @id @default(uuid()) @db.Uuid
  name          String    @unique @db.VarChar(255)
  contactName   String?   @map("contact_name") @db.VarChar(255)
  contactEmail  String?   @map("contact_email") @db.VarChar(255)
  contactPhone  String?   @map("contact_phone") @db.VarChar(20)
  notes         String?   @db.Text
  isActive      Boolean   @default(true) @map("is_active")
  createdByUserId String  @map("created_by_user_id") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt    DateTime? @map("archived_at") @db.Timestamptz(6)

  createdByUser User          @relation("CreatedTeams", fields: [createdByUserId], references: [id], onDelete: Restrict)
  contracts     Contract[]    @relation("AssignedTeamContracts")
  appointments  Appointment[] @relation("AssignedTeamAppointments")
  jobs          Job[]         @relation("AssignedTeamJobs")

  @@index([isActive])
  @@index([createdByUserId])
  @@index([archivedAt])
  @@map("teams")
}

// ============================================================
// JOB / WORK ORDER TABLES
// ============================================================

model Job {
  id               String    @id @default(uuid()) @db.Uuid
  jobNumber        String    @unique @map("job_number") @db.VarChar(50)
  contractId       String    @map("contract_id") @db.Uuid
  facilityId       String    @map("facility_id") @db.Uuid
  accountId        String    @map("account_id") @db.Uuid
  assignedTeamId   String?   @map("assigned_team_id") @db.Uuid
  assignedToUserId String?   @map("assigned_to_user_id") @db.Uuid
  jobType          String    @default("scheduled_service") @map("job_type") @db.VarChar(30)
  jobCategory      String    @default("one_time") @map("job_category") @db.VarChar(20)
  status           String    @default("scheduled") @db.VarChar(30)
  scheduledDate    DateTime  @map("scheduled_date") @db.Date
  scheduledStartTime DateTime? @map("scheduled_start_time") @db.Timestamptz(6)
  scheduledEndTime   DateTime? @map("scheduled_end_time") @db.Timestamptz(6)
  actualStartTime    DateTime? @map("actual_start_time") @db.Timestamptz(6)
  actualEndTime      DateTime? @map("actual_end_time") @db.Timestamptz(6)
  estimatedHours     Decimal?  @map("estimated_hours") @db.Decimal(6, 2)
  actualHours        Decimal?  @map("actual_hours") @db.Decimal(6, 2)
  notes              String?   @db.Text
  completionNotes    String?   @map("completion_notes") @db.Text
  createdByUserId    String    @map("created_by_user_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  contract       Contract   @relation("ContractJobs", fields: [contractId], references: [id], onDelete: Restrict)
  facility       Facility   @relation("FacilityJobs", fields: [facilityId], references: [id], onDelete: Restrict)
  account        Account    @relation("AccountJobs", fields: [accountId], references: [id], onDelete: Restrict)
  assignedTeam   Team?      @relation("AssignedTeamJobs", fields: [assignedTeamId], references: [id], onDelete: SetNull)
  assignedToUser User?      @relation("AssignedJobs", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  createdByUser  User       @relation("CreatedJobs", fields: [createdByUserId], references: [id], onDelete: Restrict)

  tasks          JobTask[]
  notes_         JobNote[]
  activities     JobActivity[]
  inspections    Inspection[] @relation("JobInspections")
  timeEntries    TimeEntry[]  @relation("JobTimeEntries")

  @@index([jobNumber])
  @@index([contractId])
  @@index([facilityId])
  @@index([accountId])
  @@index([assignedTeamId])
  @@index([assignedToUserId])
  @@index([jobType])
  @@index([jobCategory])
  @@index([status])
  @@index([scheduledDate])
  @@index([createdAt])
  @@map("jobs")
}

model JobTask {
  id               String    @id @default(uuid()) @db.Uuid
  jobId            String    @map("job_id") @db.Uuid
  facilityTaskId   String?   @map("facility_task_id") @db.Uuid
  taskName         String    @map("task_name") @db.VarChar(255)
  description      String?   @db.Text
  status           String    @default("pending") @db.VarChar(30)
  estimatedMinutes Int?      @map("estimated_minutes")
  actualMinutes    Int?      @map("actual_minutes")
  completedByUserId String?  @map("completed_by_user_id") @db.Uuid
  completedAt      DateTime? @map("completed_at") @db.Timestamptz(6)
  notes            String?   @db.Text
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  job             Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  facilityTask    FacilityTask? @relation("JobFacilityTasks", fields: [facilityTaskId], references: [id], onDelete: SetNull)
  completedByUser User?         @relation("CompletedJobTasks", fields: [completedByUserId], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([facilityTaskId])
  @@index([status])
  @@map("job_tasks")
}

model JobNote {
  id              String   @id @default(uuid()) @db.Uuid
  jobId           String   @map("job_id") @db.Uuid
  noteType        String   @default("general") @map("note_type") @db.VarChar(30)
  content         String   @db.Text
  photoUrl        String?  @map("photo_url") @db.Text
  createdByUserId String   @map("created_by_user_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  job             Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdByUser   User @relation("CreatedJobNotes", fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([jobId])
  @@index([noteType])
  @@map("job_notes")
}

model JobActivity {
  id                String   @id @default(uuid()) @db.Uuid
  jobId             String   @map("job_id") @db.Uuid
  action            String   @db.VarChar(50)
  performedByUserId String?  @map("performed_by_user_id") @db.Uuid
  metadata          Json     @default("{}") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  job             Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  performedByUser User? @relation("JobActivities", fields: [performedByUserId], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([action])
  @@index([createdAt])
  @@map("job_activities")
}

// ============================================================
// INSPECTION TABLES
// ============================================================

model InspectionTemplate {
  id                  String    @id @default(uuid()) @db.Uuid
  name                String    @db.VarChar(255)
  description         String?   @db.Text
  facilityTypeFilter  String?   @map("facility_type_filter") @db.VarChar(50)
  contractId          String?   @map("contract_id") @db.Uuid
  createdByUserId     String    @map("created_by_user_id") @db.Uuid
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt          DateTime? @map("archived_at") @db.Timestamptz(6)

  items               InspectionTemplateItem[]
  inspections         Inspection[]
  contract            Contract? @relation("ContractInspectionTemplates", fields: [contractId], references: [id], onDelete: SetNull)
  createdByUser       User @relation("CreatedInspectionTemplates", fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([contractId])
  @@index([archivedAt])
  @@map("inspection_templates")
}

model InspectionTemplateItem {
  id         String @id @default(uuid()) @db.Uuid
  templateId String @map("template_id") @db.Uuid
  category   String @db.VarChar(100)
  itemText   String @map("item_text") @db.VarChar(500)
  sortOrder  Int    @default(0) @map("sort_order")
  weight     Int    @default(1)

  template   InspectionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("inspection_template_items")
}

model Inspection {
  id                String    @id @default(uuid()) @db.Uuid
  inspectionNumber  String    @unique @map("inspection_number") @db.VarChar(50)
  templateId        String?   @map("template_id") @db.Uuid
  jobId             String?   @map("job_id") @db.Uuid
  contractId        String?   @map("contract_id") @db.Uuid
  facilityId        String    @map("facility_id") @db.Uuid
  accountId         String    @map("account_id") @db.Uuid
  inspectorUserId   String    @map("inspector_user_id") @db.Uuid
  status            String    @default("scheduled") @db.VarChar(30)
  scheduledDate     DateTime  @map("scheduled_date") @db.Date
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)
  overallScore      Decimal?  @map("overall_score") @db.Decimal(5, 2)
  overallRating     String?   @map("overall_rating") @db.VarChar(20)
  notes             String?   @db.Text
  summary           String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  template          InspectionTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  job               Job?                @relation("JobInspections", fields: [jobId], references: [id], onDelete: SetNull)
  contract          Contract?           @relation("ContractInspections", fields: [contractId], references: [id], onDelete: SetNull)
  facility          Facility            @relation("FacilityInspections", fields: [facilityId], references: [id], onDelete: Restrict)
  account           Account             @relation("AccountInspections", fields: [accountId], references: [id], onDelete: Restrict)
  inspectorUser     User                @relation("InspectorInspections", fields: [inspectorUserId], references: [id], onDelete: Restrict)

  items             InspectionItem[]
  activities        InspectionActivity[]
  correctiveActions InspectionCorrectiveAction[]
  signoffs          InspectionSignoff[]
  appointment       Appointment?   @relation("AppointmentInspection")

  @@index([inspectionNumber])
  @@index([templateId])
  @@index([jobId])
  @@index([contractId])
  @@index([facilityId])
  @@index([accountId])
  @@index([inspectorUserId])
  @@index([status])
  @@index([scheduledDate])
  @@map("inspections")
}

model InspectionItem {
  id               String   @id @default(uuid()) @db.Uuid
  inspectionId     String   @map("inspection_id") @db.Uuid
  templateItemId   String?  @map("template_item_id") @db.Uuid
  category         String   @db.VarChar(100)
  itemText         String   @map("item_text") @db.VarChar(500)
  score            String?  @db.VarChar(10)
  rating           Int?
  notes            String?  @db.Text
  photoUrl         String?  @map("photo_url") @db.Text
  sortOrder        Int      @default(0) @map("sort_order")

  inspection       Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  correctiveActions InspectionCorrectiveAction[]

  @@index([inspectionId])
  @@map("inspection_items")
}

model InspectionActivity {
  id                String   @id @default(uuid()) @db.Uuid
  inspectionId      String   @map("inspection_id") @db.Uuid
  action            String   @db.VarChar(50)
  performedByUserId String?  @map("performed_by_user_id") @db.Uuid
  metadata          Json     @default("{}") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  inspection        Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  performedByUser   User?      @relation("InspectionActivities", fields: [performedByUserId], references: [id], onDelete: SetNull)

  @@index([inspectionId])
  @@index([action])
  @@index([createdAt])
  @@map("inspection_activities")
}

model InspectionCorrectiveAction {
  id                  String    @id @default(uuid()) @db.Uuid
  inspectionId        String    @map("inspection_id") @db.Uuid
  inspectionItemId    String?   @map("inspection_item_id") @db.Uuid
  title               String    @db.VarChar(255)
  description         String?   @db.Text
  severity            String    @default("major") @db.VarChar(20)
  status              String    @default("open") @db.VarChar(30)
  dueDate             DateTime? @map("due_date") @db.Date
  assigneeUserId      String?   @map("assignee_user_id") @db.Uuid
  createdByUserId     String    @map("created_by_user_id") @db.Uuid
  resolvedByUserId    String?   @map("resolved_by_user_id") @db.Uuid
  resolvedAt          DateTime? @map("resolved_at") @db.Timestamptz(6)
  resolutionNotes     String?   @map("resolution_notes") @db.Text
  verifiedByUserId    String?   @map("verified_by_user_id") @db.Uuid
  verifiedAt          DateTime? @map("verified_at") @db.Timestamptz(6)
  followUpInspectionId String?  @map("follow_up_inspection_id") @db.Uuid
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  inspection          Inspection      @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  inspectionItem      InspectionItem? @relation(fields: [inspectionItemId], references: [id], onDelete: SetNull)
  assigneeUser        User?           @relation("AssignedInspectionCorrectiveActions", fields: [assigneeUserId], references: [id], onDelete: SetNull)
  createdByUser       User            @relation("CreatedInspectionCorrectiveActions", fields: [createdByUserId], references: [id], onDelete: Restrict)
  resolvedByUser      User?           @relation("ResolvedInspectionCorrectiveActions", fields: [resolvedByUserId], references: [id], onDelete: SetNull)
  verifiedByUser      User?           @relation("VerifiedInspectionCorrectiveActions", fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  @@index([inspectionId])
  @@index([inspectionItemId])
  @@index([status])
  @@index([severity])
  @@index([dueDate])
  @@map("inspection_corrective_actions")
}

model InspectionSignoff {
  id             String   @id @default(uuid()) @db.Uuid
  inspectionId   String   @map("inspection_id") @db.Uuid
  signerType     String   @map("signer_type") @db.VarChar(20)
  signerName     String   @map("signer_name") @db.VarChar(255)
  signerTitle    String?  @map("signer_title") @db.VarChar(255)
  comments       String?  @db.Text
  signedByUserId String?  @map("signed_by_user_id") @db.Uuid
  signedAt       DateTime @default(now()) @map("signed_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  signedByUser User?      @relation("InspectionSignoffs", fields: [signedByUserId], references: [id], onDelete: SetNull)

  @@index([inspectionId])
  @@index([signerType])
  @@index([signedAt])
  @@map("inspection_signoffs")
}

// ============================================================
// TIME TRACKING
// ============================================================

model TimeEntry {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  jobId           String?   @map("job_id") @db.Uuid
  contractId      String?   @map("contract_id") @db.Uuid
  facilityId      String?   @map("facility_id") @db.Uuid
  entryType       String    @default("clock_in") @map("entry_type") @db.VarChar(20)
  clockIn         DateTime  @map("clock_in") @db.Timestamptz(6)
  clockOut        DateTime? @map("clock_out") @db.Timestamptz(6)
  breakMinutes    Int       @default(0) @map("break_minutes")
  totalHours      Decimal?  @map("total_hours") @db.Decimal(6, 2)
  notes           String?   @db.Text
  status          String    @default("active") @db.VarChar(20)
  approvedByUserId String?  @map("approved_by_user_id") @db.Uuid
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)
  editedByUserId  String?   @map("edited_by_user_id") @db.Uuid
  editReason      String?   @map("edit_reason") @db.Text
  geoLocation     Json?     @map("geo_location") @db.JsonB
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  user            User      @relation("UserTimeEntries", fields: [userId], references: [id], onDelete: Restrict)
  job             Job?      @relation("JobTimeEntries", fields: [jobId], references: [id], onDelete: SetNull)
  contract        Contract? @relation("ContractTimeEntries", fields: [contractId], references: [id], onDelete: SetNull)
  facility        Facility? @relation("FacilityTimeEntries", fields: [facilityId], references: [id], onDelete: SetNull)
  approvedByUser  User?     @relation("ApprovedTimeEntries", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  editedByUser    User?     @relation("EditedTimeEntries", fields: [editedByUserId], references: [id], onDelete: SetNull)
  timesheetId     String?   @map("timesheet_id") @db.Uuid
  timesheet       Timesheet? @relation("TimesheetEntries", fields: [timesheetId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([jobId])
  @@index([contractId])
  @@index([facilityId])
  @@index([status])
  @@index([clockIn])
  @@index([timesheetId])
  @@map("time_entries")
}

model Timesheet {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  periodStart     DateTime  @map("period_start") @db.Date
  periodEnd       DateTime  @map("period_end") @db.Date
  status          String    @default("draft") @db.VarChar(20)
  totalHours      Decimal   @default(0) @map("total_hours") @db.Decimal(6, 2)
  regularHours    Decimal   @default(0) @map("regular_hours") @db.Decimal(6, 2)
  overtimeHours   Decimal   @default(0) @map("overtime_hours") @db.Decimal(6, 2)
  approvedByUserId String?  @map("approved_by_user_id") @db.Uuid
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  user            User       @relation("UserTimesheets", fields: [userId], references: [id], onDelete: Restrict)
  approvedByUser  User?      @relation("ApprovedTimesheets", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  entries         TimeEntry[] @relation("TimesheetEntries")

  @@unique([userId, periodStart, periodEnd])
  @@index([userId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("timesheets")
}

// ============================================================
// INVOICING
// ============================================================

model Invoice {
  id                    String    @id @default(uuid()) @db.Uuid
  invoiceNumber         String    @unique @map("invoice_number") @db.VarChar(50)
  contractId            String?   @map("contract_id") @db.Uuid
  accountId             String    @map("account_id") @db.Uuid
  facilityId            String?   @map("facility_id") @db.Uuid
  status                String    @default("draft") @db.VarChar(20)
  issueDate             DateTime  @map("issue_date") @db.Date
  dueDate               DateTime  @map("due_date") @db.Date
  periodStart           DateTime? @map("period_start") @db.Date
  periodEnd             DateTime? @map("period_end") @db.Date
  subtotal              Decimal   @default(0) @db.Decimal(12, 2)
  taxRate               Decimal   @default(0) @map("tax_rate") @db.Decimal(5, 4)
  taxAmount             Decimal   @default(0) @map("tax_amount") @db.Decimal(12, 2)
  totalAmount           Decimal   @default(0) @map("total_amount") @db.Decimal(12, 2)
  amountPaid            Decimal   @default(0) @map("amount_paid") @db.Decimal(12, 2)
  balanceDue            Decimal   @default(0) @map("balance_due") @db.Decimal(12, 2)
  notes                 String?   @db.Text
  paymentInstructions   String?   @map("payment_instructions") @db.Text
  publicToken           String?   @unique @map("public_token") @db.VarChar(100)
  publicTokenExpiresAt  DateTime? @map("public_token_expires_at") @db.Timestamptz(6)
  sentAt                DateTime? @map("sent_at") @db.Timestamptz(6)
  viewedAt              DateTime? @map("viewed_at") @db.Timestamptz(6)
  paidAt                DateTime? @map("paid_at") @db.Timestamptz(6)
  createdByUserId       String    @map("created_by_user_id") @db.Uuid
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt            DateTime? @map("archived_at") @db.Timestamptz(6)

  contract              Contract?         @relation("ContractInvoices", fields: [contractId], references: [id], onDelete: SetNull)
  account               Account           @relation("AccountInvoices", fields: [accountId], references: [id], onDelete: Restrict)
  facility              Facility?         @relation("FacilityInvoices", fields: [facilityId], references: [id], onDelete: SetNull)
  createdByUser         User              @relation("CreatedInvoices", fields: [createdByUserId], references: [id], onDelete: Restrict)
  items                 InvoiceItem[]
  payments              InvoicePayment[]
  activities            InvoiceActivity[]

  @@index([invoiceNumber])
  @@index([contractId])
  @@index([accountId])
  @@index([facilityId])
  @@index([status])
  @@index([dueDate])
  @@index([publicToken])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(uuid()) @db.Uuid
  invoiceId   String  @map("invoice_id") @db.Uuid
  itemType    String  @default("service") @map("item_type") @db.VarChar(20)
  description String  @db.Text
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @default(0) @map("unit_price") @db.Decimal(12, 2)
  totalPrice  Decimal @default(0) @map("total_price") @db.Decimal(12, 2)
  sortOrder   Int     @default(0) @map("sort_order")

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model InvoicePayment {
  id               String   @id @default(uuid()) @db.Uuid
  invoiceId        String   @map("invoice_id") @db.Uuid
  paymentDate      DateTime @map("payment_date") @db.Date
  amount           Decimal  @db.Decimal(12, 2)
  paymentMethod    String   @map("payment_method") @db.VarChar(20)
  referenceNumber  String?  @map("reference_number") @db.VarChar(100)
  notes            String?  @db.Text
  recordedByUserId String   @map("recorded_by_user_id") @db.Uuid
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  invoice          Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  recordedByUser   User    @relation("RecordedPayments", fields: [recordedByUserId], references: [id], onDelete: Restrict)

  @@index([invoiceId])
  @@map("invoice_payments")
}

model InvoiceActivity {
  id                String   @id @default(uuid()) @db.Uuid
  invoiceId         String   @map("invoice_id") @db.Uuid
  action            String   @db.VarChar(50)
  performedByUserId String?  @map("performed_by_user_id") @db.Uuid
  metadata          Json     @default("{}") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  invoice           Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  performedByUser   User?   @relation("InvoiceActivities", fields: [performedByUserId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([action])
  @@index([createdAt])
  @@map("invoice_activities")
}

// ============================================================
// QUOTATIONS
// ============================================================

model Quotation {
  id                   String    @id @default(uuid()) @db.Uuid
  accountId            String    @map("account_id") @db.Uuid
  facilityId           String?   @map("facility_id") @db.Uuid
  quotationNumber      String    @unique @map("quotation_number") @db.VarChar(50)
  title                String    @db.VarChar(255)
  status               String    @default("draft") @db.VarChar(20)
  description          String?   @db.Text
  subtotal             Decimal   @default(0) @db.Decimal(12, 2)
  taxRate              Decimal   @default(0) @map("tax_rate") @db.Decimal(5, 4)
  taxAmount            Decimal   @default(0) @map("tax_amount") @db.Decimal(12, 2)
  totalAmount          Decimal   @default(0) @map("total_amount") @db.Decimal(12, 2)
  validUntil           DateTime? @map("valid_until") @db.Date
  notes                String?   @db.Text
  termsAndConditions   String?   @map("terms_and_conditions") @db.Text
  sentAt               DateTime? @map("sent_at") @db.Timestamptz(6)
  viewedAt             DateTime? @map("viewed_at") @db.Timestamptz(6)
  acceptedAt           DateTime? @map("accepted_at") @db.Timestamptz(6)
  rejectedAt           DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectionReason      String?   @map("rejection_reason") @db.Text

  // Public access fields
  publicToken            String?   @unique @map("public_token") @db.VarChar(64)
  publicTokenExpiresAt   DateTime? @map("public_token_expires_at") @db.Timestamptz(6)
  signatureName          String?   @map("signature_name") @db.VarChar(255)
  signatureDate          DateTime? @map("signature_date") @db.Timestamptz(6)
  signatureIp            String?   @map("signature_ip") @db.VarChar(45)

  createdByUserId      String    @map("created_by_user_id") @db.Uuid
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt           DateTime? @map("archived_at") @db.Timestamptz(6)

  account              Account           @relation("AccountQuotations", fields: [accountId], references: [id])
  facility             Facility?         @relation("FacilityQuotations", fields: [facilityId], references: [id])
  createdByUser        User              @relation("CreatedQuotations", fields: [createdByUserId], references: [id])
  services             QuotationService[]
  activities           QuotationActivity[]

  @@index([accountId])
  @@index([facilityId])
  @@index([status])
  @@index([quotationNumber])
  @@index([validUntil])
  @@index([sentAt])
  @@index([publicToken])
  @@map("quotations")
}

model QuotationService {
  id             String   @id @default(uuid()) @db.Uuid
  quotationId    String   @map("quotation_id") @db.Uuid
  serviceName    String   @map("service_name") @db.VarChar(255)
  description    String?  @db.Text
  price          Decimal  @db.Decimal(12, 2)
  includedTasks  Json     @default("[]") @map("included_tasks") @db.JsonB
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quotation      Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@index([quotationId])
  @@map("quotation_services")
}

model QuotationActivity {
  id                String   @id @default(uuid()) @db.Uuid
  quotationId       String   @map("quotation_id") @db.Uuid
  action            String   @db.VarChar(50)
  performedByUserId String?  @map("performed_by_user_id") @db.Uuid
  metadata          Json     @default("{}") @db.JsonB
  ipAddress         String?  @map("ip_address") @db.VarChar(45)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  quotation         Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  performedByUser   User?     @relation("QuotationActivities", fields: [performedByUserId], references: [id])

  @@index([quotationId])
  @@index([action])
  @@index([createdAt])
  @@map("quotation_activities")
}

// ============================================================
// SETTINGS
// ============================================================

model GlobalSettings {
  id                   String   @id @default("global") @db.VarChar(32)
  companyName          String   @default("Hygieia Cleaning Services") @map("company_name") @db.VarChar(255)
  companyEmail         String?  @map("company_email") @db.VarChar(255)
  companyPhone         String?  @map("company_phone") @db.VarChar(20)
  companyWebsite       String?  @map("company_website") @db.VarChar(500)
  companyAddress       String?  @map("company_address") @db.Text
  logoDataUrl          String?  @map("logo_data_url") @db.Text
  themePrimaryColor    String   @default("#1a1a2e") @map("theme_primary_color") @db.VarChar(7)
  themeAccentColor     String   @default("#d4af37") @map("theme_accent_color") @db.VarChar(7)
  themeBackgroundColor String   @default("#f5f5f5") @map("theme_background_color") @db.VarChar(7)
  themeTextColor       String   @default("#333333") @map("theme_text_color") @db.VarChar(7)
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("global_settings")
}
