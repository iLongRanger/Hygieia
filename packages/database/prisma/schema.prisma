// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// CORE IDENTITY TABLES
// ============================================================

model User {
  id             String    @id @default(uuid()) @db.Uuid
  supabaseUserId String?   @unique @map("supabase_user_id") @db.Uuid
  email          String    @unique @db.VarChar(255)
  passwordHash   String?   @map("password_hash") @db.VarChar(255)
  fullName       String    @map("full_name") @db.VarChar(255)
  phone          String?   @db.VarChar(20)
  avatarUrl      String?   @map("avatar_url") @db.Text
  status         String    @default("active") @db.VarChar(20)
  lastLoginAt    DateTime? @map("last_login_at") @db.Timestamptz(6)
  preferences    Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  roles                    UserRole[]        @relation("UserRoles")
  createdLeads             Lead[]            @relation("CreatedLeads")
  createdAccounts          Account[]         @relation("CreatedAccounts")
  createdContacts          Contact[]         @relation("CreatedContacts")
  createdFacilities        Facility[]        @relation("CreatedFacilities")
  createdAreas             Area[]            @relation("CreatedAreas")
  createdTasks             FacilityTask[]    @relation("CreatedTasks")
  assignedToLeads          Lead[]            @relation("AssignedToLeads")
  convertedLeads           Lead[]            @relation("ConvertedLeads")
  managedAccounts          Account[]         @relation("AccountManager")
  facilities               Facility[]        @relation("FacilityManager")
  createdTaskTemplates     TaskTemplate[]    @relation("CreatedTaskTemplates")
  createdAreaTemplates     AreaTemplate[]    @relation("CreatedAreaTemplates")
  createdPricingRules      PricingRule[]     @relation("CreatedPricingRules")
  pricingOverrides         PricingOverride[] @relation("CreatedPricingOverrides")
  approvedPricingOverrides PricingOverride[] @relation("ApprovedPricingOverrides")
  createdProposals         Proposal[]        @relation("CreatedProposals")
  createdContracts         Contract[]        @relation("CreatedContracts")
  approvedContracts        Contract[]        @relation("ApprovedContracts")
  initialCleanCompletedContracts Contract[]  @relation("InitialCleanCompletedContracts")
  createdAppointments      Appointment[]     @relation("CreatedAppointments")
  assignedAppointments     Appointment[]     @relation("AssignedAppointments")
  notifications            Notification[]    @relation("UserNotifications")

  @@index([email])
  @@index([status])
  @@map("users")
}

model Role {
  id           String   @id @default(uuid()) @db.Uuid
  key          String   @unique @db.VarChar(50)
  label        String   @db.VarChar(100)
  description  String?  @db.Text
  permissions  Json     @default("{}") @db.JsonB
  isSystemRole Boolean  @default(false) @map("is_system_role")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  id               String    @id @default(uuid()) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  roleId           String    @map("role_id") @db.Uuid
  assignedByUserId String?   @map("assigned_by_user_id") @db.Uuid
  assignedAt       DateTime  @default(now()) @map("assigned_at") @db.Timestamptz(6)
  expiresAt        DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// ============================================================
// CRM & SALES PIPELINE TABLES
// ============================================================

model LeadSource {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  color       String   @default("#6B7280") @db.VarChar(7)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  leads Lead[]

  @@index([isActive])
  @@map("lead_sources")
}

model Lead {
  id                String    @id @default(uuid()) @db.Uuid
  leadSourceId      String?   @map("lead_source_id") @db.Uuid
  status            String    @default("lead") @db.VarChar(30)
  companyName       String?   @map("company_name") @db.VarChar(255)
  contactName       String    @map("contact_name") @db.VarChar(255)
  primaryEmail      String?   @map("primary_email") @db.VarChar(255)
  primaryPhone      String?   @map("primary_phone") @db.VarChar(20)
  secondaryEmail    String?   @map("secondary_email") @db.VarChar(255)
  secondaryPhone    String?   @map("secondary_phone") @db.VarChar(20)
  address           Json?     @db.JsonB
  estimatedValue    Decimal?  @map("estimated_value") @db.Decimal(12, 2)
  probability       Int?      @default(0)
  expectedCloseDate DateTime? @map("expected_close_date") @db.Date
  notes             String?   @db.Text
  lostReason        String?   @map("lost_reason") @db.Text
  assignedToUserId  String?   @map("assigned_to_user_id") @db.Uuid
  createdByUserId   String    @map("created_by_user_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt        DateTime? @map("archived_at") @db.Timestamptz(6)

  // Conversion tracking
  convertedToAccountId String?   @unique @map("converted_to_account_id") @db.Uuid
  convertedAt          DateTime? @map("converted_at") @db.Timestamptz(6)
  convertedByUserId    String?   @map("converted_by_user_id") @db.Uuid

  leadSource         LeadSource? @relation(fields: [leadSourceId], references: [id])
  assignedToUser     User?       @relation("AssignedToLeads", fields: [assignedToUserId], references: [id])
  createdByUser      User        @relation("CreatedLeads", fields: [createdByUserId], references: [id])
  convertedToAccount Account?    @relation("LeadToAccount", fields: [convertedToAccountId], references: [id])
  convertedByUser    User?       @relation("ConvertedLeads", fields: [convertedByUserId], references: [id])
  appointments       Appointment[] @relation("LeadAppointments")

  @@index([status])
  @@index([leadSourceId])
  @@index([assignedToUserId])
  @@index([primaryEmail])
  @@index([expectedCloseDate])
  @@index([createdAt])
  @@index([convertedToAccountId])
  @@map("leads")
}

model Appointment {
  id                String    @id @default(uuid()) @db.Uuid
  leadId            String    @map("lead_id") @db.Uuid
  type              String    @default("walk_through") @db.VarChar(30)
  status            String    @default("scheduled") @db.VarChar(30)
  scheduledStart    DateTime  @map("scheduled_start") @db.Timestamptz(6)
  scheduledEnd      DateTime  @map("scheduled_end") @db.Timestamptz(6)
  timezone          String    @db.VarChar(50)
  location          String?   @db.Text
  notes             String?   @db.Text
  assignedToUserId  String    @map("assigned_to_user_id") @db.Uuid
  createdByUserId   String    @map("created_by_user_id") @db.Uuid
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)
  rescheduledFromId String?   @map("rescheduled_from_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  lead            Lead         @relation("LeadAppointments", fields: [leadId], references: [id], onDelete: Cascade)
  assignedToUser  User         @relation("AssignedAppointments", fields: [assignedToUserId], references: [id])
  createdByUser   User         @relation("CreatedAppointments", fields: [createdByUserId], references: [id])
  rescheduledFrom Appointment? @relation("AppointmentReschedules", fields: [rescheduledFromId], references: [id])
  reschedules     Appointment[] @relation("AppointmentReschedules")

  @@index([leadId])
  @@index([assignedToUserId])
  @@index([scheduledStart])
  @@index([status])
  @@map("appointments")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String   @db.VarChar(50)
  title     String   @db.VarChar(255)
  body      String?  @db.Text
  metadata  Json     @default("{}") @db.JsonB
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([readAt])
  @@map("notifications")
}

model Account {
  id               String    @id @default(uuid()) @db.Uuid
  name             String    @unique @db.VarChar(255)
  type             String    @db.VarChar(20)
  industry         String?   @db.VarChar(100)
  website          String?   @db.VarChar(500)
  billingEmail     String?   @map("billing_email") @db.VarChar(255)
  billingPhone     String?   @map("billing_phone") @db.VarChar(20)
  billingAddress   Json?     @map("billing_address") @db.JsonB
  qboCustomerId    String?   @map("qbo_customer_id") @db.VarChar(50)
  taxId            String?   @map("tax_id") @db.VarChar(50)
  paymentTerms     String    @default("NET30") @map("payment_terms") @db.VarChar(50)
  creditLimit      Decimal?  @map("credit_limit") @db.Decimal(12, 2)
  accountManagerId String?   @map("account_manager_id") @db.Uuid
  notes            String?   @db.Text
  createdByUserId  String    @map("created_by_user_id") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt       DateTime? @map("archived_at") @db.Timestamptz(6)

  // Pricing strategy default for this account
  defaultPricingStrategyKey String? @default("sqft_settings_v1") @map("default_pricing_strategy_key") @db.VarChar(100)

  contacts       Contact[]
  facilities     Facility[]
  proposals      Proposal[]
  contracts      Contract[]
  accountManager User?      @relation("AccountManager", fields: [accountManagerId], references: [id])
  createdByUser  User       @relation("CreatedAccounts", fields: [createdByUserId], references: [id])
  sourceLead     Lead?      @relation("LeadToAccount")

  @@index([type])
  @@index([accountManagerId])
  @@index([qboCustomerId])
  @@index([defaultPricingStrategyKey])
  @@map("accounts")
}

model Contact {
  id              String    @id @default(uuid()) @db.Uuid
  accountId       String?   @map("account_id") @db.Uuid
  name            String    @db.VarChar(255)
  email           String?   @db.VarChar(255)
  phone           String?   @db.VarChar(20)
  mobile          String?   @db.VarChar(20)
  title           String?   @db.VarChar(100)
  department      String?   @db.VarChar(100)
  isPrimary       Boolean   @default(false) @map("is_primary")
  isBilling       Boolean   @default(false) @map("is_billing")
  notes           String?   @db.Text
  createdByUserId String    @map("created_by_user_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt      DateTime? @map("archived_at") @db.Timestamptz(6)

  account       Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  createdByUser User     @relation("CreatedContacts", fields: [createdByUserId], references: [id])

  @@unique([accountId, isPrimary])
  @@index([accountId])
  @@index([email])
  @@index([isPrimary])
  @@index([isBilling])
  @@map("contacts")
}

// ============================================================
// FACILITY MANAGEMENT TABLES
// ============================================================

model AreaType {
  id                      String   @id @default(uuid()) @db.Uuid
  name                    String   @unique @db.VarChar(100)
  description             String?  @db.Text
  defaultSquareFeet       Decimal? @map("default_square_feet") @db.Decimal(10, 2)
  baseCleaningTimeMinutes Int?     @map("base_cleaning_time_minutes")
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  areas         Area[]
  taskTemplates TaskTemplate[]
  pricingRules  PricingRule[]
  areaTemplate  AreaTemplate?

  @@index([name])
  @@map("area_types")
}

model Facility {
  id                  String    @id @default(uuid()) @db.Uuid
  accountId           String    @map("account_id") @db.Uuid
  name                String    @db.VarChar(255)
  address             Json      @db.JsonB
  squareFeet          Decimal?  @map("square_feet") @db.Decimal(10, 2)
  buildingType        String?   @map("building_type") @db.VarChar(50)
  accessInstructions  String?   @map("access_instructions") @db.Text
  parkingInfo         String?   @map("parking_info") @db.Text
  specialRequirements String?   @map("special_requirements") @db.Text
  facilityManagerId   String?   @map("facility_manager_id") @db.Uuid
  status              String    @default("active") @db.VarChar(20)
  notes               String?   @db.Text
  createdByUserId     String    @map("created_by_user_id") @db.Uuid
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt          DateTime? @map("archived_at") @db.Timestamptz(6)

  // Pricing strategy default for this facility (overrides account default)
  defaultPricingStrategyKey String? @default("sqft_settings_v1") @map("default_pricing_strategy_key") @db.VarChar(100)

  account          Account           @relation(fields: [accountId], references: [id])
  areas            Area[]
  taskTemplates    TaskTemplate[]    @relation("FacilityTaskTemplates")
  facilityTasks    FacilityTask[]    @relation("FacilityTasks")
  pricingOverrides PricingOverride[] @relation("FacilityPricingOverrides")
  proposals        Proposal[]
  contracts        Contract[]
  facilityManager  User?             @relation("FacilityManager", fields: [facilityManagerId], references: [id])
  createdByUser    User              @relation("CreatedFacilities", fields: [createdByUserId], references: [id])

  @@unique([accountId, name])
  @@index([accountId])
  @@index([status])
  @@index([facilityManagerId])
  @@index([defaultPricingStrategyKey])
  @@map("facilities")
}

model Area {
  id              String    @id @default(uuid()) @db.Uuid
  facilityId      String    @map("facility_id") @db.Uuid
  areaTypeId      String    @map("area_type_id") @db.Uuid
  name            String?   @db.VarChar(255)
  quantity        Int       @default(1)
  squareFeet      Decimal?  @map("square_feet") @db.Decimal(10, 2)
  floorType       String    @default("vct") @map("floor_type") @db.VarChar(20)
  conditionLevel  String    @default("standard") @map("condition_level") @db.VarChar(20)
  roomCount       Int       @default(0) @map("room_count")
  unitCount       Int       @default(0) @map("unit_count")
  trafficLevel    String    @default("medium") @map("traffic_level") @db.VarChar(20)
  notes           String?   @db.Text
  createdByUserId String    @map("created_by_user_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt      DateTime? @map("archived_at") @db.Timestamptz(6)

  facility      Facility       @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  areaType      AreaType       @relation(fields: [areaTypeId], references: [id])
  facilityTasks FacilityTask[]
  fixtures      AreaFixture[]
  createdByUser User           @relation("CreatedAreas", fields: [createdByUserId], references: [id])

  @@unique([facilityId, name])
  @@index([facilityId])
  @@index([areaTypeId])
  @@index([conditionLevel])
  @@index([floorType])
  @@index([trafficLevel])
  @@map("areas")
}

// ============================================================
// TASK MANAGEMENT TABLES
// ============================================================

model TaskTemplate {
  id                String    @id @default(uuid()) @db.Uuid
  name              String    @db.VarChar(255)
  description       String?   @db.Text
  cleaningType      String    @map("cleaning_type") @db.VarChar(50)
  areaTypeId        String?   @map("area_type_id") @db.Uuid
  estimatedMinutes  Int       @map("estimated_minutes")
  baseMinutes       Decimal   @default(0) @map("base_minutes") @db.Decimal(10, 4)
  perSqftMinutes    Decimal   @default(0) @map("per_sqft_minutes") @db.Decimal(10, 4)
  perUnitMinutes    Decimal   @default(0) @map("per_unit_minutes") @db.Decimal(10, 4)
  perRoomMinutes    Decimal   @default(0) @map("per_room_minutes") @db.Decimal(10, 4)
  difficultyLevel   Int       @default(3) @map("difficulty_level")
  requiredEquipment Json      @default("[]") @map("required_equipment") @db.JsonB
  requiredSupplies  Json      @default("[]") @map("required_supplies") @db.JsonB
  instructions      String?   @db.Text
  isGlobal          Boolean   @default(false) @map("is_global")
  facilityId        String?   @map("facility_id") @db.Uuid
  version           Int       @default(1)
  isActive          Boolean   @default(true) @map("is_active")
  createdByUserId   String    @map("created_by_user_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt        DateTime? @map("archived_at") @db.Timestamptz(6)

  areaType             AreaType?            @relation(fields: [areaTypeId], references: [id])
  facility             Facility?            @relation("FacilityTaskTemplates", fields: [facilityId], references: [id])
  facilityTasks        FacilityTask[]
  fixtureMinutes       TaskFixtureMinutes[]
  areaTemplateTasks    AreaTemplateTask[]
  createdByUser        User                 @relation("CreatedTaskTemplates", fields: [createdByUserId], references: [id])

  @@index([cleaningType])
  @@index([areaTypeId])
  @@index([facilityId])
  @@index([isActive])
  @@index([isGlobal])
  @@map("task_templates")
}

model FacilityTask {
  id                  String    @id @default(uuid()) @db.Uuid
  facilityId          String    @map("facility_id") @db.Uuid
  areaId              String?   @map("area_id") @db.Uuid
  taskTemplateId      String?   @map("task_template_id") @db.Uuid
  customName          String?   @map("custom_name") @db.VarChar(255)
  customInstructions  String?   @map("custom_instructions") @db.Text
  estimatedMinutes    Int?      @map("estimated_minutes")
  baseMinutesOverride    Decimal? @map("base_minutes_override") @db.Decimal(10, 4)
  perSqftMinutesOverride Decimal? @map("per_sqft_minutes_override") @db.Decimal(10, 4)
  perUnitMinutesOverride Decimal? @map("per_unit_minutes_override") @db.Decimal(10, 4)
  perRoomMinutesOverride Decimal? @map("per_room_minutes_override") @db.Decimal(10, 4)
  isRequired          Boolean   @default(true) @map("is_required")
  cleaningFrequency   String    @default("daily") @map("cleaning_frequency") @db.VarChar(20)
  conditionMultiplier Decimal   @default(1.0) @map("condition_multiplier") @db.Decimal(3, 2)
  priority            Int       @default(3)
  createdByUserId     String    @map("created_by_user_id") @db.Uuid
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt          DateTime? @map("archived_at") @db.Timestamptz(6)

  facility            Facility                   @relation("FacilityTasks", fields: [facilityId], references: [id], onDelete: Cascade)
  area                Area?                      @relation(fields: [areaId], references: [id])
  taskTemplate        TaskTemplate?              @relation(fields: [taskTemplateId], references: [id])
  fixtureMinutes      FacilityTaskFixtureMinutes[]
  createdByUser       User                       @relation("CreatedTasks", fields: [createdByUserId], references: [id])

  @@index([facilityId])
  @@index([areaId])
  @@index([taskTemplateId])
  @@index([cleaningFrequency])
  @@index([priority])
  @@map("facility_tasks")
}

// ============================================================
// PRICING TABLES
// ============================================================

model PricingSettings {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique @db.VarChar(100)

  // Base Rate
  baseRatePerSqFt      Decimal @default(0.10) @map("base_rate_per_sq_ft") @db.Decimal(8, 4)
  minimumMonthlyCharge Decimal @default(250) @map("minimum_monthly_charge") @db.Decimal(10, 2)
  hourlyRate           Decimal @default(35.00) @map("hourly_rate") @db.Decimal(8, 2)

  // Labor Cost Settings
  laborCostPerHour       Decimal @default(18.00) @map("labor_cost_per_hour") @db.Decimal(8, 2) // Average hourly wage
  laborBurdenPercentage  Decimal @default(0.25) @map("labor_burden_percentage") @db.Decimal(5, 4) // Payroll taxes, benefits (25%)
  sqftPerLaborHour       Decimal @default(2500) @map("sqft_per_labor_hour") @db.Decimal(10, 2) // Productivity rate: sq ft cleaned per hour

  // Overhead Cost Settings (as percentages of labor cost)
  insurancePercentage     Decimal @default(0.08) @map("insurance_percentage") @db.Decimal(5, 4) // Liability + workers comp (8%)
  adminOverheadPercentage Decimal @default(0.12) @map("admin_overhead_percentage") @db.Decimal(5, 4) // Admin costs (12%)
  travelCostPerVisit      Decimal @default(15.00) @map("travel_cost_per_visit") @db.Decimal(8, 2) // Flat travel cost per visit
  equipmentPercentage     Decimal @default(0.05) @map("equipment_percentage") @db.Decimal(5, 4) // Equipment depreciation (5%)

  // Supply Cost Settings
  supplyCostPercentage Decimal @default(0.04) @map("supply_cost_percentage") @db.Decimal(5, 4) // Supplies as % of labor+overhead (4%)
  supplyCostPerSqFt    Decimal? @map("supply_cost_per_sq_ft") @db.Decimal(8, 4) // Alternative: flat rate per sq ft

  // Profit Settings
  targetProfitMargin Decimal @default(0.25) @map("target_profit_margin") @db.Decimal(5, 4) // Target profit margin (25%)

  // Multipliers stored as JSON
  floorTypeMultipliers    Json @default("{\"vct\": 1.0, \"carpet\": 1.15, \"tile\": 1.1, \"hardwood\": 1.2, \"concrete\": 0.9, \"other\": 1.0}") @map("floor_type_multipliers") @db.JsonB
  frequencyMultipliers    Json @default("{\"1x_week\": 1.0, \"2x_week\": 1.8, \"3x_week\": 2.5, \"4x_week\": 3.2, \"5x_week\": 4.0, \"daily\": 4.33, \"weekly\": 1.0, \"biweekly\": 0.5, \"monthly\": 0.25, \"quarterly\": 0.083}") @map("frequency_multipliers") @db.JsonB
  conditionMultipliers    Json @default("{\"standard\": 1.0, \"medium\": 1.25, \"hard\": 1.33}") @map("condition_multipliers") @db.JsonB
  trafficMultipliers      Json @default("{\"low\": 0.9, \"medium\": 1.0, \"high\": 1.15}") @map("traffic_multipliers") @db.JsonB
  buildingTypeMultipliers Json @default("{\"office\": 1.0, \"medical\": 1.3, \"industrial\": 1.15, \"retail\": 1.05, \"educational\": 1.1, \"warehouse\": 0.9, \"residential\": 1.0, \"mixed\": 1.05, \"other\": 1.0}") @map("building_type_multipliers") @db.JsonB
  taskComplexityAddOns    Json @default("{\"standard\": 0, \"sanitization\": 0.15, \"biohazard\": 0.5, \"high_security\": 0.2}") @map("task_complexity_add_ons") @db.JsonB

  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt DateTime? @map("archived_at") @db.Timestamptz(6)

  @@index([isActive])
  @@map("pricing_settings")
}

model FixtureType {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  category    String   @default("fixture") @db.VarChar(20)
  defaultMinutesPerItem Decimal @default(0) @map("default_minutes_per_item") @db.Decimal(10, 4)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  areaFixtures              AreaFixture[]
  taskFixtureMinutes        TaskFixtureMinutes[]
  facilityTaskFixtureMinutes FacilityTaskFixtureMinutes[]
  areaTemplateItems         AreaTemplateItem[]

  @@index([isActive])
  @@map("fixture_types")
}

model AreaFixture {
  id            String    @id @default(uuid()) @db.Uuid
  areaId        String    @map("area_id") @db.Uuid
  fixtureTypeId String    @map("fixture_type_id") @db.Uuid
  count         Int       @default(0)
  minutesPerItem Decimal  @default(0) @map("minutes_per_item") @db.Decimal(10, 4)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  area        Area        @relation(fields: [areaId], references: [id], onDelete: Cascade)
  fixtureType FixtureType @relation(fields: [fixtureTypeId], references: [id], onDelete: Cascade)

  @@unique([areaId, fixtureTypeId])
  @@index([areaId])
  @@index([fixtureTypeId])
  @@map("area_fixtures")
}

model AreaTemplate {
  id                String    @id @default(uuid()) @db.Uuid
  areaTypeId        String    @unique @map("area_type_id") @db.Uuid
  name              String?   @db.VarChar(255)
  defaultSquareFeet Decimal?  @map("default_square_feet") @db.Decimal(10, 2)
  createdByUserId   String    @map("created_by_user_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  areaType    AreaType          @relation(fields: [areaTypeId], references: [id])
  items       AreaTemplateItem[]
  tasks       AreaTemplateTask[]
  createdByUser User            @relation("CreatedAreaTemplates", fields: [createdByUserId], references: [id])

  @@index([areaTypeId])
  @@map("area_templates")
}

model AreaTemplateItem {
  id             String    @id @default(uuid()) @db.Uuid
  areaTemplateId String    @map("area_template_id") @db.Uuid
  fixtureTypeId  String    @map("fixture_type_id") @db.Uuid
  defaultCount   Int       @default(0) @map("default_count")
  minutesPerItem Decimal   @default(0) @map("minutes_per_item") @db.Decimal(10, 4)
  sortOrder      Int       @default(0) @map("sort_order")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  areaTemplate AreaTemplate @relation(fields: [areaTemplateId], references: [id], onDelete: Cascade)
  fixtureType  FixtureType  @relation(fields: [fixtureTypeId], references: [id], onDelete: Cascade)

  @@unique([areaTemplateId, fixtureTypeId])
  @@index([areaTemplateId])
  @@index([fixtureTypeId])
  @@map("area_template_items")
}

model AreaTemplateTask {
  id             String    @id @default(uuid()) @db.Uuid
  areaTemplateId String    @map("area_template_id") @db.Uuid
  taskTemplateId String?   @map("task_template_id") @db.Uuid
  name           String?   @db.VarChar(255)
  baseMinutes    Decimal?  @map("base_minutes") @db.Decimal(10, 4)
  perSqftMinutes Decimal?  @map("per_sqft_minutes") @db.Decimal(10, 4)
  perUnitMinutes Decimal?  @map("per_unit_minutes") @db.Decimal(10, 4)
  perRoomMinutes Decimal?  @map("per_room_minutes") @db.Decimal(10, 4)
  sortOrder      Int       @default(0) @map("sort_order")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  areaTemplate AreaTemplate @relation(fields: [areaTemplateId], references: [id], onDelete: Cascade)
  taskTemplate TaskTemplate? @relation(fields: [taskTemplateId], references: [id], onDelete: SetNull)

  @@index([areaTemplateId])
  @@index([areaTemplateId, sortOrder])
  @@index([taskTemplateId])
  @@map("area_template_tasks")
}

model TaskFixtureMinutes {
  id                String    @id @default(uuid()) @db.Uuid
  taskTemplateId    String    @map("task_template_id") @db.Uuid
  fixtureTypeId     String    @map("fixture_type_id") @db.Uuid
  minutesPerFixture Decimal   @default(0) @map("minutes_per_fixture") @db.Decimal(10, 4)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  taskTemplate TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  fixtureType  FixtureType  @relation(fields: [fixtureTypeId], references: [id], onDelete: Cascade)

  @@unique([taskTemplateId, fixtureTypeId])
  @@index([taskTemplateId])
  @@index([fixtureTypeId])
  @@map("task_fixture_minutes")
}

model FacilityTaskFixtureMinutes {
  id                String    @id @default(uuid()) @db.Uuid
  facilityTaskId    String    @map("facility_task_id") @db.Uuid
  fixtureTypeId     String    @map("fixture_type_id") @db.Uuid
  minutesPerFixture Decimal   @default(0) @map("minutes_per_fixture") @db.Decimal(10, 4)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  facilityTask FacilityTask @relation(fields: [facilityTaskId], references: [id], onDelete: Cascade)
  fixtureType  FixtureType  @relation(fields: [fixtureTypeId], references: [id], onDelete: Cascade)

  @@unique([facilityTaskId, fixtureTypeId])
  @@index([facilityTaskId])
  @@index([fixtureTypeId])
  @@map("facility_task_fixture_minutes")
}

model PricingRule {
  id                   String    @id @default(uuid()) @db.Uuid
  name                 String    @db.VarChar(255)
  description          String?   @db.Text
  pricingType          String    @map("pricing_type") @db.VarChar(20)
  baseRate             Decimal   @map("base_rate") @db.Decimal(10, 2)
  minimumCharge        Decimal?  @map("minimum_charge") @db.Decimal(10, 2)
  squareFootRate       Decimal?  @map("square_foot_rate") @db.Decimal(8, 4)
  difficultyMultiplier Decimal   @default(1.0) @map("difficulty_multiplier") @db.Decimal(4, 3)
  conditionMultipliers Json      @default("{\"excellent\": 0.8, \"good\": 1.0, \"fair\": 1.3, \"poor\": 1.6}") @map("condition_multipliers") @db.JsonB
  cleaningType         String?   @map("cleaning_type") @db.VarChar(50)
  areaTypeId           String?   @map("area_type_id") @db.Uuid
  isActive             Boolean   @default(true) @map("is_active")
  createdByUserId      String    @map("created_by_user_id") @db.Uuid
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt           DateTime? @map("archived_at") @db.Timestamptz(6)

  areaType         AreaType?         @relation(fields: [areaTypeId], references: [id])
  pricingOverrides PricingOverride[]
  createdByUser    User              @relation("CreatedPricingRules", fields: [createdByUserId], references: [id])

  @@index([pricingType])
  @@index([cleaningType])
  @@index([areaTypeId])
  @@index([isActive])
  @@map("pricing_rules")
}

model PricingOverride {
  id               String    @id @default(uuid()) @db.Uuid
  facilityId       String    @map("facility_id") @db.Uuid
  pricingRuleId    String    @map("pricing_rule_id") @db.Uuid
  overrideRate     Decimal   @map("override_rate") @db.Decimal(10, 2)
  overrideReason   String    @map("override_reason") @db.Text
  effectiveDate    DateTime  @default(now()) @map("effective_date") @db.Date
  expiryDate       DateTime? @map("expiry_date") @db.Date
  approvedByUserId String?   @map("approved_by_user_id") @db.Uuid
  createdByUserId  String    @map("created_by_user_id") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  facility       Facility    @relation("FacilityPricingOverrides", fields: [facilityId], references: [id], onDelete: Cascade)
  pricingRule    PricingRule @relation(fields: [pricingRuleId], references: [id])
  approvedByUser User?       @relation("ApprovedPricingOverrides", fields: [approvedByUserId], references: [id])
  createdByUser  User        @relation("CreatedPricingOverrides", fields: [createdByUserId], references: [id])

  @@index([facilityId])
  @@index([effectiveDate])
  @@index([expiryDate])
  @@map("pricing_overrides")
}

// ============================================================
// PROPOSAL & ESTIMATE TABLES
// ============================================================

model Proposal {
  id                 String    @id @default(uuid()) @db.Uuid
  accountId          String    @map("account_id") @db.Uuid
  facilityId         String?   @map("facility_id") @db.Uuid
  proposalNumber     String    @unique @map("proposal_number") @db.VarChar(50)
  title              String    @db.VarChar(255)
  status             String    @default("draft") @db.VarChar(20)
  description        String?   @db.Text
  subtotal           Decimal   @default(0) @map("subtotal") @db.Decimal(12, 2)
  taxRate            Decimal   @default(0) @map("tax_rate") @db.Decimal(5, 4)
  taxAmount          Decimal   @default(0) @map("tax_amount") @db.Decimal(12, 2)
  totalAmount        Decimal   @default(0) @map("total_amount") @db.Decimal(12, 2)
  validUntil         DateTime? @map("valid_until") @db.Date
  sentAt             DateTime? @map("sent_at") @db.Timestamptz(6)
  viewedAt           DateTime? @map("viewed_at") @db.Timestamptz(6)
  acceptedAt         DateTime? @map("accepted_at") @db.Timestamptz(6)
  rejectedAt         DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectionReason    String?   @map("rejection_reason") @db.Text
  notes              String?   @db.Text
  termsAndConditions String?   @map("terms_and_conditions") @db.Text
  createdByUserId    String    @map("created_by_user_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt         DateTime? @map("archived_at") @db.Timestamptz(6)

  // Pricing strategy fields
  pricingStrategyKey     String?   @map("pricing_strategy_key") @db.VarChar(100)
  pricingStrategyVersion String?   @map("pricing_strategy_version") @db.VarChar(50)
  pricingSnapshot        Json?     @map("pricing_snapshot") @db.JsonB
  pricingLocked          Boolean   @default(false) @map("pricing_locked")
  pricingLockedAt        DateTime? @map("pricing_locked_at") @db.Timestamptz(6)

  account          Account           @relation(fields: [accountId], references: [id])
  facility         Facility?         @relation(fields: [facilityId], references: [id])
  createdByUser    User              @relation("CreatedProposals", fields: [createdByUserId], references: [id])
  proposalItems    ProposalItem[]
  proposalServices ProposalService[]
  contracts        Contract[]

  @@index([accountId])
  @@index([facilityId])
  @@index([status])
  @@index([proposalNumber])
  @@index([validUntil])
  @@index([sentAt])
  @@index([pricingStrategyKey])
  @@index([pricingLocked])
  @@map("proposals")
}

model ProposalItem {
  id          String   @id @default(uuid()) @db.Uuid
  proposalId  String   @map("proposal_id") @db.Uuid
  itemType    String   @map("item_type") @db.VarChar(50)
  description String   @db.Text
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal  @map("total_price") @db.Decimal(12, 2)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([itemType])
  @@map("proposal_items")
}

model ProposalService {
  id             String   @id @default(uuid()) @db.Uuid
  proposalId     String   @map("proposal_id") @db.Uuid
  serviceName    String   @map("service_name") @db.VarChar(255)
  serviceType    String   @map("service_type") @db.VarChar(50)
  frequency      String   @db.VarChar(20)
  estimatedHours Decimal? @map("estimated_hours") @db.Decimal(10, 2)
  hourlyRate     Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  monthlyPrice   Decimal  @map("monthly_price") @db.Decimal(12, 2)
  description    String?  @db.Text
  includedTasks  Json     @default("[]") @map("included_tasks") @db.JsonB
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([serviceType])
  @@map("proposal_services")
}

// ============================================================
// CONTRACTS & AGREEMENTS TABLES
// ============================================================

model Contract {
  id             String  @id @default(uuid()) @db.Uuid
  contractNumber String  @unique @map("contract_number") @db.VarChar(50)
  title          String  @db.VarChar(255)
  status         String  @default("draft") @db.VarChar(30)
  contractSource String  @default("proposal") @map("contract_source") @db.VarChar(20)
  accountId      String  @map("account_id") @db.Uuid
  facilityId     String? @map("facility_id") @db.Uuid
  proposalId     String? @map("proposal_id") @db.Uuid

  // Renewal tracking
  renewedFromContractId String? @unique @map("renewed_from_contract_id") @db.Uuid
  renewalNumber         Int     @default(0) @map("renewal_number")

  // Service Terms
  startDate         DateTime  @map("start_date") @db.Date
  endDate           DateTime? @map("end_date") @db.Date
  serviceFrequency  String?   @map("service_frequency") @db.VarChar(30)
  serviceSchedule   Json?     @map("service_schedule") @db.JsonB
  autoRenew         Boolean   @default(false) @map("auto_renew")
  renewalNoticeDays Int?      @default(30) @map("renewal_notice_days")

  // Financial Terms
  monthlyValue Decimal  @map("monthly_value") @db.Decimal(12, 2)
  totalValue   Decimal? @map("total_value") @db.Decimal(12, 2)
  billingCycle String   @default("monthly") @map("billing_cycle") @db.VarChar(20)
  paymentTerms String   @default("Net 30") @map("payment_terms") @db.VarChar(50)

  // Contract Details
  termsAndConditions  String? @map("terms_and_conditions") @db.Text
  specialInstructions String? @map("special_instructions") @db.Text

  // Document Management
  signedDocumentUrl String?   @map("signed_document_url") @db.Text
  signedDate        DateTime? @map("signed_date") @db.Date
  signedByName      String?   @map("signed_by_name") @db.VarChar(255)
  signedByEmail     String?   @map("signed_by_email") @db.VarChar(255)

  // Workflow
  approvedByUserId  String?   @map("approved_by_user_id") @db.Uuid
  approvedAt        DateTime? @map("approved_at") @db.Timestamptz(6)
  terminationReason String?   @map("termination_reason") @db.Text
  terminatedAt      DateTime? @map("terminated_at") @db.Timestamptz(6)

  // Initial Clean Tracking
  includesInitialClean        Boolean   @default(true) @map("includes_initial_clean")
  initialCleanCompleted       Boolean   @default(false) @map("initial_clean_completed")
  initialCleanCompletedAt     DateTime? @map("initial_clean_completed_at") @db.Timestamptz(6)
  initialCleanCompletedByUserId String?  @map("initial_clean_completed_by_user_id") @db.Uuid

  // Audit
  createdByUserId String    @map("created_by_user_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt      DateTime? @map("archived_at") @db.Timestamptz(6)

  // Relations
  account                    Account   @relation(fields: [accountId], references: [id], onDelete: Restrict)
  facility                   Facility? @relation(fields: [facilityId], references: [id], onDelete: Restrict)
  proposal                   Proposal? @relation(fields: [proposalId], references: [id])
  approvedByUser             User?     @relation("ApprovedContracts", fields: [approvedByUserId], references: [id])
  createdByUser              User      @relation("CreatedContracts", fields: [createdByUserId], references: [id])
  initialCleanCompletedByUser User?    @relation("InitialCleanCompletedContracts", fields: [initialCleanCompletedByUserId], references: [id])
  renewedFromContract        Contract? @relation("ContractRenewal", fields: [renewedFromContractId], references: [id])
  renewedToContract          Contract? @relation("ContractRenewal")

  @@index([contractNumber])
  @@index([status])
  @@index([contractSource])
  @@index([accountId])
  @@index([facilityId])
  @@index([proposalId])
  @@index([renewedFromContractId])
  @@index([startDate])
  @@index([endDate])
  @@index([createdAt])
  @@map("contracts")
}
